{% extends "base.html" %}
{% set active_page = "bookings" %}

{% block title %}Manage Event: {{ booking.name }}{% endblock %}

{% block page_header %}
<h1 class="title">Manage Event</h1>
<h2 class="subtitle">{{ booking.name }}</h2>
{% endblock %}

{% block content %}
<div class="container">
    <div class="columns">
        <div class="column is-8">
            <div class="box">
                <h3 class="title is-4">Event Details</h3>
                
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="tabs is-boxed">
                        <ul>
                            <li class="is-active" data-tab="event">
                                <a>
                                    <span class="icon is-small"><i class="fas fa-trophy" aria-hidden="true"></i></span>
                                    <span>Event Details</span>
                                </a>
                            </li>
                            <li data-tab="logistics">
                                <a>
                                    <span class="icon is-small"><i class="fas fa-calendar" aria-hidden="true"></i></span>
                                    <span>Date & Logistics</span>
                                </a>
                            </li>
                            <li data-tab="series">
                                <a>
                                    <span class="icon is-small"><i class="fas fa-copy" aria-hidden="true"></i></span>
                                    <span>Series & Duplication</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Event Details Tab -->
                    <div class="tab-content is-active" data-content="event">
                        <div class="field">
                            <label class="label">{{ form.name.label }}</label>
                            <div class="control">
                                {{ form.name(class="input") }}
                            </div>
                            {% for error in form.name.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                    
                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="label">{{ form.event_type.label }}</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            {{ form.event_type }}
                                        </div>
                                    </div>
                                    {% for error in form.event_type.errors %}
                                        <p class="help is-danger">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">{{ form.format.label }}</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            {{ form.format }}
                                        </div>
                                    </div>
                                    {% for error in form.format.errors %}
                                        <p class="help is-danger">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="label">{{ form.gender.label }}</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            {{ form.gender }}
                                        </div>
                                    </div>
                                    {% for error in form.gender.errors %}
                                        <p class="help is-danger">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">{{ form.scoring.label }}</label>
                                    <div class="control">
                                        {{ form.scoring(class="input") }}
                                    </div>
                                    {% for error in form.scoring.errors %}
                                        <p class="help is-danger">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="field">
                            <div class="control">
                                <label class="checkbox">
                                    {{ form.has_pool }}
                                    Enable Pool Registration
                                </label>
                            </div>
                            <p class="help">Enable pool registration to allow members to register interest before team selection</p>
                        </div>
                    </div>
                    
                    <!-- Date & Logistics Tab -->
                    <div class="tab-content" data-content="logistics">
                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="label">{{ form.booking_date.label }}</label>
                                    <div class="control">
                                        {{ form.booking_date(class="input") }}
                                    </div>
                                    {% for error in form.booking_date.errors %}
                                        <p class="help is-danger">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">{{ form.session.label }}</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            {{ form.session }}
                                        </div>
                                    </div>
                                    {% for error in form.session.errors %}
                                        <p class="help is-danger">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="label">{{ form.rink_count.label }}</label>
                                    <div class="control">
                                        {{ form.rink_count(class="input") }}
                                    </div>
                                    {% for error in form.rink_count.errors %}
                                        <p class="help is-danger">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">{{ form.home_away.label }}</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            {{ form.home_away }}
                                        </div>
                                    </div>
                                    {% for error in form.home_away.errors %}
                                        <p class="help is-danger">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="field">
                            <label class="label">{{ form.vs.label }}</label>
                            <div class="control">
                                {{ form.vs(class="input") }}
                            </div>
                            {% for error in form.vs.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Series & Duplication Tab -->
                    <div class="tab-content" data-content="series">
                        {{ form.series_id }}
                        
                        
                        <div class="field">
                            <div class="control">
                                <label class="checkbox">
                                    {{ form.create_series }}
                                    Series Booking
                                </label>
                            </div>
                            <p class="help">This booking is part of a series with multiple dates</p>
                        </div>
                        
                        <div class="field">
                            <label class="label">{{ form.series_name.label }}</label>
                            <div class="control">
                                {{ form.series_name(class="input") }}
                            </div>
                            {% for error in form.series_name.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                            <p class="help">Optional: Give this series a descriptive name</p>
                        </div>
                        
                        <hr>
                        
                        <div class="field">
                            <label class="label">{{ form.existing_series.label }}</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    {{ form.existing_series }}
                                </div>
                            </div>
                            {% for error in form.existing_series.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                            <p class="help">Add this booking to an existing series</p>
                        </div>
                        
                        <div class="notification is-warning">
                            <p><strong>Duplication Options:</strong></p>
                            <ul>
                                <li><strong>Save Event:</strong> Updates the current event with your changes</li>
                                <li><strong>Duplicate to New Date:</strong> Creates a copy of this event that you can modify for a different date</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="field is-grouped">
                        <div class="control">
                            {{ form.submit(class="button is-primary") }}
                        </div>
                        <div class="control">
                            <button type="button" class="button is-info" onclick="openDuplicateModal()">
                                <span class="icon">
                                    <i class="fas fa-copy"></i>
                                </span>
                                <span>Duplicate</span>
                            </button>
                        </div>
                        <div class="control">
                            <a href="{{ url_for('bookings.admin_list_bookings') }}" class="button is-light">
                                <span class="icon">
                                    <i class="fas fa-arrow-left"></i>
                                </span>
                                <span>Back to Events</span>
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="column is-4">
            <div class="box">
                <h3 class="title is-5">Event Statistics</h3>
                
                <div class="content">
                    <dl>
                        <dt><strong>Teams:</strong></dt>
                        <dd>{{ stats.total_teams }} teams created</dd>
                        
                        <dt><strong>Date:</strong></dt>
                        <dd>{{ booking.booking_date.strftime('%d %B %Y') }}</dd>
                        
                        {% if stats.has_pool %}
                        <dt><strong>Pool Registration:</strong></dt>
                        <dd>{{ stats.pool_members }} members registered</dd>
                        {% else %}
                        <dt><strong>Pool:</strong></dt>
                        <dd>Pool registration not enabled</dd>
                        {% endif %}
                        
                        <dt><strong>Type:</strong></dt>
                        <dd>{{ booking.get_event_type_name() }}</dd>
                        
                        <dt><strong>Format:</strong></dt>
                        <dd>{{ booking.get_format_name() }}</dd>
                    </dl>
                </div>
                
                <div class="buttons">
                    <a href="{{ url_for('bookings.admin_manage_teams', booking_id=booking.id) }}" 
                       class="button is-success is-fullwidth">
                        <span class="icon">
                            <i class="fas fa-users"></i>
                        </span>
                        <span>Manage Teams</span>
                    </a>
                </div>
                
                <hr>
                
                <form method="POST" action="{{ url_for('bookings.admin_delete_booking', booking_id=booking.id) }}" 
                      onsubmit="return confirm('Are you sure you want to delete this event? This action cannot be undone.');">
                    {{ form.hidden_tag() }}
                    <button type="submit" class="button is-danger is-fullwidth">
                        <span class="icon">
                            <i class="fas fa-trash"></i>
                        </span>
                        <span>Delete Event</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Duplicate Modal -->
<div class="modal" id="duplicateModal">
    <div class="modal-background" onclick="closeDuplicateModal()"></div>
    <div class="modal-content">
        <div class="box">
            <h3 class="title is-4">Duplicate Event</h3>
            <p class="subtitle is-6">Modify the details for the duplicate event</p>
            
            <form id="duplicateForm" method="POST">
                {{ form.hidden_tag() }}
                <input type="hidden" name="action" value="duplicate">
                
                <div class="field">
                    <label class="label">Event Date</label>
                    <div class="control">
                        <input type="date" name="duplicate_date" id="duplicate_date" class="input" required 
                               value="{{ booking.booking_date.strftime('%Y-%m-%d') if booking.booking_date }}">
                    </div>
                </div>
                
                <div class="field">
                    <label class="label">Session</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select name="duplicate_session" id="duplicate_session" required>
                                {% for key, value in config.get('DAILY_SESSIONS', {}).items() %}
                                <option value="{{ key }}" {% if key == booking.session %}selected{% endif %}>{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="field">
                    <label class="label">Venue</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select name="duplicate_venue" id="duplicate_venue">
                                <option value="">Select venue...</option>
                                {% for key, value in config.get('HOME_AWAY_OPTIONS', {}).items() %}
                                <option value="{{ value }}" {% if value == booking.home_away %}selected{% endif %}>{{ key }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="field">
                    <label class="label">Opposition Team</label>
                    <div class="control">
                        <input type="text" name="duplicate_opposition" id="duplicate_opposition" class="input" 
                               value="{{ booking.vs if booking.vs }}" placeholder="Enter opposition team name">
                    </div>
                </div>
                
                <div class="field is-grouped">
                    <div class="control">
                        <button type="submit" class="button is-primary">
                            <span class="icon">
                                <i class="fas fa-copy"></i>
                            </span>
                            <span>Create Duplicate</span>
                        </button>
                    </div>
                    <div class="control">
                        <button type="button" class="button" onclick="closeDuplicateModal()">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <button class="modal-close is-large" onclick="closeDuplicateModal()"></button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    const tabs = document.querySelectorAll('.tabs li');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all tabs and content
            tabs.forEach(t => t.classList.remove('is-active'));
            tabContents.forEach(content => content.classList.remove('is-active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('is-active');
            const targetContent = document.querySelector(`[data-content="${targetTab}"]`);
            if (targetContent) {
                targetContent.classList.add('is-active');
            }
        });
    });
    
    // Handle series dropdown selection
    const existingSeriesDropdown = document.getElementById('existing_series');
    const createSeriesCheckbox = document.getElementById('create_series');
    const seriesIdField = document.getElementById('series_id');
    const seriesNameField = document.getElementById('series_name');
    
    if (existingSeriesDropdown && createSeriesCheckbox) {
        existingSeriesDropdown.addEventListener('change', function() {
            if (this.value) {
                // A series was selected
                const selectedSeriesId = this.value;
                const selectedSeriesName = this.options[this.selectedIndex].text;
                
                // Check the Series Booking checkbox
                createSeriesCheckbox.checked = true;
                
                // Update the hidden series_id field
                if (seriesIdField) {
                    seriesIdField.value = selectedSeriesId;
                }
                
                // Update the series_name field
                if (seriesNameField) {
                    seriesNameField.value = selectedSeriesName;
                }
                
                console.log('Series selected:', selectedSeriesId, selectedSeriesName);
            } else {
                // No series selected - clear everything
                createSeriesCheckbox.checked = false;
                
                if (seriesIdField) {
                    seriesIdField.value = '';
                }
                
                if (seriesNameField) {
                    seriesNameField.value = '';
                }
                
                console.log('Series selection cleared');
            }
        });
    }
});

// Modal functions
function openDuplicateModal() {
    document.getElementById('duplicateModal').classList.add('is-active');
}

function closeDuplicateModal() {
    document.getElementById('duplicateModal').classList.remove('is-active');
}
</script>
{% endblock %}