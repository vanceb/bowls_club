{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="title">My Games</h1>
    <p class="subtitle">View and confirm your availability for upcoming team assignments. Please confirm your availability at least {{ config.get('AVAILABILITY_DEADLINE_DAYS', 7) }} days before each game date. Once confirmed, contact the event organizer to make changes.</p>

    {% if assignments or roll_up_invitations or pool_registrations %}
    <!-- Group all games, roll-ups, and pool registrations by status and date -->
    {% set pool_awaiting_selection = [] %}
    {% set pending_games = [] %}
    {% set confirmed_games = [] %}
    {% set unavailable_games = [] %}
    {% set played_games = [] %}
    
    <!-- Process pool registrations first - these go at the top as they're awaiting team selection -->
    {% for registration in pool_registrations %}
        {% set game_date = registration.pool.booking.booking_date %}
        {% if game_date < today %}
            {% set _ = played_games.append({'type': 'pool_registration', 'data': registration}) %}
        {% else %}
            {% set _ = pool_awaiting_selection.append({'type': 'pool_registration', 'data': registration}) %}
        {% endif %}
    {% endfor %}
    
    <!-- Process regular team assignments -->
    {% for assignment in assignments %}
        {% set game_date = assignment.team.booking.booking_date %}
        {% if game_date < today %}
            {% set _ = played_games.append({'type': 'assignment', 'data': assignment}) %}
        {% elif assignment.availability_status == 'pending' %}
            {% set _ = pending_games.append({'type': 'assignment', 'data': assignment}) %}
        {% elif assignment.availability_status == 'available' %}
            {% set _ = confirmed_games.append({'type': 'assignment', 'data': assignment}) %}
        {% elif assignment.availability_status == 'unavailable' %}
            {% set _ = unavailable_games.append({'type': 'assignment', 'data': assignment}) %}
        {% endif %}
    {% endfor %}
    
    <!-- Process roll-up invitations -->
    {% for invitation in roll_up_invitations %}
        {% set game_date = invitation.team.booking.booking_date %}
        {% if game_date < today %}
            {% set _ = played_games.append({'type': 'rollup', 'data': invitation}) %}
        {% elif invitation.availability_status == 'pending' %}
            {% set _ = pending_games.append({'type': 'rollup', 'data': invitation}) %}
        {% elif invitation.availability_status == 'available' %}
            {% set _ = confirmed_games.append({'type': 'rollup', 'data': invitation}) %}
        {% elif invitation.availability_status == 'unavailable' %}
            {% set _ = unavailable_games.append({'type': 'rollup', 'data': invitation}) %}
        {% endif %}
    {% endfor %}

    <!-- Sort each group by date (nearest first) - we'll handle mixed types in the template -->
    {% set pool_sorted = [] %}
    {% set pending_sorted = [] %}
    {% set confirmed_sorted = [] %}
    {% set unavailable_sorted = [] %}
    {% set played_sorted = [] %}
    
    <!-- Sort pool registrations awaiting selection -->
    {% for item in pool_awaiting_selection %}
        {% set _ = pool_sorted.append((item.data.pool.booking.booking_date, item)) %}
    {% endfor %}
    {% set pool_awaiting_selection = (pool_sorted | sort(attribute='0') | map(attribute='1') | list) %}
    
    <!-- Create sorted lists with date extraction for mixed types -->
    {% for item in pending_games %}
        {% set _ = pending_sorted.append((item.data.team.booking.booking_date, item)) %}
    {% endfor %}
    {% set pending_games = (pending_sorted | sort(attribute='0') | map(attribute='1') | list) %}
    
    {% for item in confirmed_games %}
        {% set _ = confirmed_sorted.append((item.data.team.booking.booking_date, item)) %}
    {% endfor %}
    {% set confirmed_games = (confirmed_sorted | sort(attribute='0') | map(attribute='1') | list) %}
    
    {% for item in unavailable_games %}
        {% set _ = unavailable_sorted.append((item.data.team.booking.booking_date, item)) %}
    {% endfor %}
    {% set unavailable_games = (unavailable_sorted | sort(attribute='0') | map(attribute='1') | list) %}
    
    {% for item in played_games %}
        {% if item.type == 'pool_registration' %}
            {% set _ = played_sorted.append((item.data.pool.booking.booking_date, item)) %}
        {% else %}
            {% set _ = played_sorted.append((item.data.team.booking.booking_date, item)) %}
        {% endif %}
    {% endfor %}
    {% set played_games = (played_sorted | sort(attribute='0', reverse=true) | map(attribute='1') | list) %}

    <!-- Pool Registrations Awaiting Selection Section -->
    {% if pool_awaiting_selection %}
    <div class="box">
        <h3 class="title is-4 has-text-info">
            <span class="icon">
                <i class="fas fa-users"></i>
            </span>
            <span>Registered Interest - Awaiting Team Selection ({{ pool_awaiting_selection | length }})</span>
        </h3>
        <p class="subtitle is-6 has-text-grey">Events you've registered interest in - event managers will select teams from the pool</p>
        
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                    <tr>
                        <th style="width: 35%;">Game Details</th>
                        <th style="width: 12%;">Type</th>
                        <th style="width: 13%;">Pool</th>
                        <th style="width: 15%;">Status</th>
                        <th style="width: 25%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in pool_awaiting_selection %}
                    {% set row_class = "has-background-info-light" %}
                    {% include 'partials/game_row.html' with context %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Pending Confirmation Section -->
    {% if pending_games %}
    <div class="box">
        <h3 class="title is-4 has-text-warning">
            <span class="icon">
                <i class="fas fa-clock"></i>
            </span>
            <span>Pending Confirmation ({{ pending_games | length }})</span>
        </h3>
        <p class="subtitle is-6 has-text-grey">Games and roll-ups awaiting your response</p>
        
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                    <tr>
                        <th style="width: 35%;">Game Details</th>
                        <th style="width: 12%;">Type</th>
                        <th style="width: 13%;">Team/Role</th>
                        <th style="width: 15%;">Status</th>
                        <th style="width: 25%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in pending_games %}
                    {% set row_class = "has-background-warning-light" %}
                    {% include 'partials/game_row.html' with context %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Confirmed Games Section -->
    {% if confirmed_games %}
    <div class="box">
        <h3 class="title is-4 has-text-success">
            <span class="icon">
                <i class="fas fa-check-circle"></i>
            </span>
            <span>Confirmed Games ({{ confirmed_games | length }})</span>
        </h3>
        <p class="subtitle is-6 has-text-grey">Games and roll-ups you've confirmed to play</p>
        
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                    <tr>
                        <th style="width: 35%;">Game Details</th>
                        <th style="width: 12%;">Type</th>
                        <th style="width: 13%;">Team/Role</th>
                        <th style="width: 15%;">Status</th>
                        <th style="width: 25%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in confirmed_games %}
                    {% set row_class = "has-background-success-light" %}
                    {% include 'partials/game_row.html' with context %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Unavailable Games Section -->
    {% if unavailable_games %}
    <div class="box">
        <h3 class="title is-4 has-text-danger">
            <span class="icon">
                <i class="fas fa-times-circle"></i>
            </span>
            <span>Unavailable Games ({{ unavailable_games | length }})</span>
        </h3>
        <p class="subtitle is-6 has-text-grey">Games and roll-ups you've indicated you cannot play</p>
        
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                    <tr>
                        <th style="width: 35%;">Game Details</th>
                        <th style="width: 12%;">Type</th>
                        <th style="width: 13%;">Team/Role</th>
                        <th style="width: 15%;">Status</th>
                        <th style="width: 25%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in unavailable_games %}
                    {% set row_class = "has-background-danger-light" %}
                    {% include 'partials/game_row.html' with context %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Played Games Section -->
    {% if played_games %}
    <div class="box">
        <h3 class="title is-4 has-text-grey">
            <span class="icon">
                <i class="fas fa-history"></i>
            </span>
            <span>Played Games ({{ played_games | length }})</span>
        </h3>
        <p class="subtitle is-6 has-text-grey">Games and roll-ups that have already taken place</p>
        
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                    <tr>
                        <th style="width: 35%;">Game Details</th>
                        <th style="width: 12%;">Type</th>
                        <th style="width: 13%;">Team/Role</th>
                        <th style="width: 15%;">Status</th>
                        <th style="width: 25%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in played_games %}
                    {% set row_class = "" %}
                    {% include 'partials/game_row.html' with context %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="box">
        <div class="notification is-info">
            <div class="content has-text-centered">
                <p class="title is-4">
                    <span class="icon is-large">
                        <i class="fas fa-calendar-alt"></i>
                    </span>
                </p>
                <p class="title is-5">No upcoming games</p>
                <p>You don't have any upcoming team assignments at the moment.</p>
                <p>Check back later or contact an event organizer to get involved in upcoming games.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Summary Statistics -->
    {% if assignments or roll_up_invitations or pool_registrations %}
    <div class="box">
        <h3 class="title is-5">Summary</h3>
        <div class="columns">
            <div class="column">
                <div class="has-text-centered">
                    <p class="heading">Pool Registrations</p>
                    <p class="title is-4 has-text-info">{{ pool_awaiting_selection | length }}</p>
                </div>
            </div>
            <div class="column">
                <div class="has-text-centered">
                    <p class="heading">Pending Confirmation</p>
                    <p class="title is-4 has-text-warning">{{ pending_games | length }}</p>
                </div>
            </div>
            <div class="column">
                <div class="has-text-centered">
                    <p class="heading">Confirmed Games</p>
                    <p class="title is-4 has-text-success">{{ confirmed_games | length }}</p>
                </div>
            </div>
            <div class="column">
                <div class="has-text-centered">
                    <p class="heading">Unavailable Games</p>
                    <p class="title is-4 has-text-danger">{{ unavailable_games | length }}</p>
                </div>
            </div>
            <div class="column">
                <div class="has-text-centered">
                    <p class="heading">Played Games</p>
                    <p class="title is-4 has-text-grey">{{ played_games | length }}</p>
                </div>
            </div>
        </div>
        
    </div>
    {% endif %}
</div>
{% endblock %}