{% extends "base.html" %}
{% set active_page = "admin" %}

{% block title %}Manage Teams - Booking #{{ booking.id }}{% endblock %}

{% block content %}
<div class="columns">
    <div class="column is-full">
        <h1 class="title">Manage Teams</h1>
        <h2 class="subtitle">{{ booking | booking_details | safe }}</h2>

        <div class="columns is-desktop">
            <!-- Teams Column -->
            <div class="column is-7">
                {% if teams %}
                <div class="box">
                    <h3 class="title is-4">Teams ({{ teams|length }})</h3>
                    <p class="subtitle is-6">Drag players from the right into team positions</p>
                    
                    {% for team in teams %}
                    <div class="box is-small team-container mb-4 {% if team.is_finalized() %}has-background-grey-lighter{% endif %}" data-team-id="{{ team.id }}" data-finalized="{{ 'true' if team.is_finalized() else 'false' }}">
                        <div class="level is-mobile mb-2">
                            <div class="level-left">
                                <h4 class="title is-6 mb-0">
                                    {{ team.team_name }}
                                    {% if team.is_finalized() %}
                                    <span class="icon has-text-success">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    {% endif %}
                                </h4>
                            </div>
                            <div class="level-right">
                                {% set filled_positions = team.members|length %}
                                {% set total_positions = positions|length %}
                                {% if team.is_finalized() %}
                                <span class="tag is-success">
                                    <span class="icon is-small">
                                        <i class="fas fa-check"></i>
                                    </span>
                                    <span>Finalized</span>
                                </span>
                                {% else %}
                                <span class="tag {% if filled_positions == total_positions %}is-success{% elif filled_positions > 0 %}is-warning{% else %}is-light{% endif %}">
                                    {{ filled_positions }}/{{ total_positions }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Compact Position Layout -->
                        <div class="columns is-multiline is-mobile team-positions">
                            {% for position in positions %}
                            {% set team_member = team.members|selectattr('position', 'equalto', position)|first %}
                            <div class="column is-half-mobile is-one-third-tablet">
                                <div class="position-slot" data-position="{{ position }}" data-team-id="{{ team.id }}">
                                    <div class="has-background-primary has-text-white has-text-centered py-1 px-2 mb-2 is-size-7 has-text-weight-semibold">
                                        {{ position }}
                                    </div>
                                    <div class="player-slot {% if team_member %}occupied{% else %}empty{% endif %}">
                                        {% if team_member %}
                                        <div class="notification is-light p-2 player-card" draggable="true" data-member-id="{{ team_member.member.id }}" data-team-member-id="{{ team_member.id }}">
                                            <button class="delete is-small remove-player" data-team-member-id="{{ team_member.id }}"></button>
                                            <p class="is-size-7 has-text-weight-semibold mb-1">{{ team_member.member.firstname }} {{ team_member.member.lastname }}</p>
                                            <span class="tag is-small {% if team_member.availability_status == 'available' %}is-success{% elif team_member.availability_status == 'unavailable' %}is-danger{% else %}is-warning{% endif %}">
                                                {{ team_member.availability_status|title }}
                                            </span>
                                        </div>
                                        {% else %}
                                        <div class="notification has-background-light has-text-grey has-text-centered p-2 empty-slot">
                                            <p class="is-size-7">Drop here</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Compact Team Actions -->
                        <div class="has-text-centered mt-2">
                            {% if team.is_finalized() %}
                            <div class="notification is-success is-light is-small p-2 mb-2">
                                <strong>Team Locked</strong> - No changes allowed
                            </div>
                            <form method="POST" style="display: inline;">
                                {{ csrf_form.hidden_tag() }}
                                <input type="hidden" name="action" value="unfinalize_team">
                                <input type="hidden" name="team_id" value="{{ team.id }}">
                                <button class="button is-warning is-small">
                                    <span class="icon is-small">
                                        <i class="fas fa-unlock"></i>
                                    </span>
                                    <span>Unlock</span>
                                </button>
                            </form>
                            {% elif filled_positions == total_positions %}
                            <form method="POST" style="display: inline;">
                                {{ csrf_form.hidden_tag() }}
                                <input type="hidden" name="action" value="finalize_team">
                                <input type="hidden" name="team_id" value="{{ team.id }}">
                                <button class="button is-success is-small">
                                    <span class="icon is-small">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                    <span>Finalize</span>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="box">
                    <p class="has-text-grey">No teams created for this booking yet.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Pool Members Column -->
            <div class="column is-5">
                <div class="box pool-container">
                    {% if available_members %}
                    <div class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <h3 class="title is-4">Pool Players ({{ available_members|length }})</h3>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <button type="button" class="button is-success is-small" onclick="openAddPlayerModal()">
                                    <span class="icon">
                                        <i class="fas fa-user-plus"></i>
                                    </span>
                                    <span>Add Player</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <p class="subtitle is-6">Drag to teams ‚Üê</p>
                    
                    <div class="pool-members" style="max-height: 70vh; overflow-y: auto;">
                        {% for member in available_members %}
                        {% set is_assigned = member.id in assigned_member_ids %}
                        <div class="notification p-3 mb-2 player-card pool-player {% if is_assigned %}has-background-grey-light player-assigned{% else %}has-background-info-light{% endif %}" draggable="{% if not is_assigned %}true{% else %}false{% endif %}" data-member-id="{{ member.id }}" data-assigned="{{ 'true' if is_assigned else 'false' }}">
                            <div class="level is-mobile">
                                <div class="level-left">
                                    <div>
                                        <p class="has-text-weight-semibold {% if is_assigned %}has-text-grey{% endif %}">{{ member.firstname }} {{ member.lastname }}</p>
                                        <p class="is-size-7 has-text-grey">Member #{{ member.id }}{% if is_assigned %} - Already Assigned{% endif %}</p>
                                    </div>
                                </div>
                                <div class="level-right">
                                    <span class="icon {% if is_assigned %}has-text-grey{% else %}has-text-info{% endif %}">
                                        {% if is_assigned %}
                                        <i class="fas fa-check"></i>
                                        {% else %}
                                        <i class="fas fa-grip-vertical"></i>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <!-- No Pool State -->
                    <div class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <h3 class="title is-4">Pool Players (0)</h3>
                            </div>
                        </div>
                        <div class="level-right">
                            <div class="level-item">
                                <button type="button" class="button is-success is-small" onclick="openAddPlayerModal()">
                                    <span class="icon">
                                        <i class="fas fa-user-plus"></i>
                                    </span>
                                    <span>Add Player</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="notification is-info is-light">
                        <div class="content">
                            <p><strong>No pool created yet.</strong></p>
                            <p>Players will be automatically added to a pool when you use the "Add Player" button above.</p>
                            <p class="is-size-7 has-text-grey">Alternatively, you can create a pool from the Event Details tab in the booking management page.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>


        <div class="box">
            <h3 class="title is-4">Add Team</h3>
            <form method="POST">
                {{ csrf_form.hidden_tag() }}
                <input type="hidden" name="action" value="add_team">
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input class="input" type="text" name="team_name" placeholder="Team name" required>
                    </div>
                    <div class="control">
                        <button class="button is-primary" type="submit">Add Team</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="field is-grouped">
            <div class="control">
                <a class="button is-light" href="{{ url_for('bookings.admin_list_bookings') }}">Back to Events</a>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for adding players to pool -->
<form method="POST" id="add-player-form" style="display: none;">
    {{ csrf_form.hidden_tag() }}
    <input type="hidden" name="action" value="add_to_pool">
    <input type="hidden" name="member_id" id="member-id-input">
</form>

<!-- Modal for adding players to pool -->
<div class="modal" id="add-player-modal">
    <div class="modal-background" onclick="closeAddPlayerModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Add Player to Pool</p>
            <button class="delete" onclick="closeAddPlayerModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Search Members</label>
                <div class="control">
                    <input class="input" type="text" id="member-search" placeholder="Type member name to search...">
                </div>
            </div>
            
            <div id="member-search-results" class="content">
                <p class="has-text-grey">Start typing to search for members...</p>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button" onclick="closeAddPlayerModal()">Cancel</button>
        </footer>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let draggedElement = null;
    let draggedMemberId = null;
    let draggedFromTeam = null;

    // Make pool players draggable (but not if already assigned)
    document.querySelectorAll('.pool-player').forEach(player => {
        player.addEventListener('dragstart', function(e) {
            // Prevent dragging if player is already assigned
            if (this.dataset.assigned === 'true') {
                e.preventDefault();
                return false;
            }
            
            draggedElement = this;
            draggedMemberId = this.dataset.memberId;
            draggedFromTeam = null;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });

        player.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
        });
    });

    // Make team players draggable - updated selector for new layout
    document.querySelectorAll('.team-container .player-card').forEach(player => {
        player.addEventListener('dragstart', function(e) {
            draggedElement = this;
            draggedMemberId = this.dataset.memberId;
            draggedFromTeam = this.closest('.team-container').dataset.teamId;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });

        player.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
        });
    });

    // Also handle newly added players (delegation)
    document.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('player-card')) {
            draggedElement = e.target;
            draggedMemberId = e.target.dataset.memberId;
            draggedFromTeam = e.target.closest('.team-container')?.dataset.teamId || null;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
    });

    document.addEventListener('dragend', function(e) {
        if (e.target.classList.contains('player-card')) {
            e.target.classList.remove('dragging');
        }
    });

    // Make position slots droppable
    document.querySelectorAll('.position-slot').forEach(slot => {
        slot.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        });

        slot.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });

        slot.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (!draggedElement || !draggedMemberId) return;

            const teamId = this.dataset.teamId;
            const position = this.dataset.position;
            const playerSlot = this.querySelector('.player-slot');
            const teamContainer = this.closest('.team-container');

            // Check if team is finalized
            if (teamContainer && teamContainer.dataset.finalized === 'true') {
                alert('This team is finalized and cannot be modified!');
                return;
            }

            // Check if position is already occupied
            if (playerSlot.classList.contains('occupied')) {
                alert('This position is already occupied!');
                return;
            }

            // Send AJAX request to assign player
            assignPlayerToTeam(draggedMemberId, teamId, position, draggedFromTeam);
        });
    });

    // Handle remove player buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-player')) {
            e.preventDefault();
            const teamMemberId = e.target.dataset.teamMemberId;
            removePlayerFromTeam(teamMemberId);
        }
    });

    function assignPlayerToTeam(memberId, teamId, position, fromTeamId = null) {
        const formData = new FormData();
        formData.append('action', 'assign_player');
        formData.append('member_id', memberId);
        formData.append('team_id', teamId);
        formData.append('position', position);
        if (fromTeamId) {
            formData.append('from_team_id', fromTeamId);
        }

        // Add CSRF token
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        formData.append('csrf_token', csrfToken);

        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh to show updated teams
            } else {
                alert(data.message || 'Error assigning player');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error assigning player');
        });
    }

    function removePlayerFromTeam(teamMemberId) {
        if (!confirm('Remove this player from the team?')) return;

        const formData = new FormData();
        formData.append('action', 'remove_player');
        formData.append('team_member_id', teamMemberId);

        // Add CSRF token
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        formData.append('csrf_token', csrfToken);

        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh to show updated teams
            } else {
                alert(data.message || 'Error removing player');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing player');
        });
    }
    
    // Modal functions for adding players to pool
    window.openAddPlayerModal = function() {
        document.getElementById('add-player-modal').classList.add('is-active');
        document.getElementById('member-search').focus();
    };

    window.closeAddPlayerModal = function() {
        document.getElementById('add-player-modal').classList.remove('is-active');
        document.getElementById('member-search').value = '';
        document.getElementById('member-search-results').innerHTML = '<p class="has-text-grey">Start typing to search for members...</p>';
    };

    window.addPlayerToPool = function(memberId) {
        document.getElementById('member-id-input').value = memberId;
        document.getElementById('add-player-form').submit();
    };

    // Member search functionality
    let searchTimeout;
    document.getElementById('member-search').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            document.getElementById('member-search-results').innerHTML = '<p class="has-text-grey">Start typing to search for members...</p>';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/members/api/v1/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    const resultsDiv = document.getElementById('member-search-results');
                    
                    if (data.success && data.members.length > 0) {
                        // Get list of current pool member IDs to exclude them
                        const currentPoolMemberIds = {{ available_members | map(attribute='id') | list | tojson }};
                        
                        // Filter out members who are already in the pool
                        const availableMembers = data.members.filter(member => !currentPoolMemberIds.includes(member.id));
                        
                        if (availableMembers.length > 0) {
                            let html = '<div class="columns is-multiline">';
                            availableMembers.forEach(member => {
                                html += `
                                    <div class="column is-half">
                                        <div class="box is-clickable" onclick="addPlayerToPool(${member.id})" style="cursor: pointer;">
                                            <div class="media">
                                                <div class="media-content">
                                                    <p class="has-text-weight-semibold">${member.firstname} ${member.lastname}</p>
                                                    <p class="is-size-7 has-text-grey">${member.status} Member</p>
                                                </div>
                                                <div class="media-right">
                                                    <span class="icon has-text-success">
                                                        <i class="fas fa-plus-circle"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            html += '</div>';
                            resultsDiv.innerHTML = html;
                        } else {
                            resultsDiv.innerHTML = '<p class="has-text-grey">All matching members are already in this pool.</p>';
                        }
                    } else {
                        resultsDiv.innerHTML = '<p class="has-text-grey">No members found matching your search.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error searching members:', error);
                    document.getElementById('member-search-results').innerHTML = '<p class="has-text-danger">Error searching members. Please try again.</p>';
                });
        }, 300);
    });

    // Handle ESC key to close modal
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeAddPlayerModal();
        }
    });
});
</script>
{% endblock %}