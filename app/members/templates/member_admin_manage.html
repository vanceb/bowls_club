{% extends "base.html" %}

{% block content %}
<h1 class="title">Manage Members</h1>

<div class="box">
    <div class="field">
        <label class="label is-size-5">Search Members</label>
        <div class="control">
            <input id="search-input" class="input" type="text" placeholder="Search by username, first name, last name, or email" autofocus>
        </div>
    </div>
</div>

<table class="table is-striped is-hoverable is-fullwidth">
    <thead>
        <tr>
            <th>Name</th>
            <th>Gender</th>
            <th>Status</th>
            <th>Last Seen</th>
            <th>Lockout</th>
            <th>Roles</th>
        </tr>
    </thead>
    <tbody id="members-table-body">
        <!-- Results will be dynamically loaded here -->
    </tbody>
</table>

<!-- Pagination controls -->
<div id="pagination-container">
    <!-- Pagination will be dynamically generated here -->
</div>

<script>
    let currentPage = 1;
    let currentQuery = '';
    const perPage = 20;
    
    function loadMembers(query = '', page = 1) {
        currentQuery = query;
        currentPage = page;
        
        // Show loading state
        const tbody = document.getElementById('members-table-body');
        tbody.innerHTML = '<tr><td colspan="6" class="has-text-centered"><span class="icon"><i class="fas fa-spinner fa-pulse"></i></span> Loading...</td></tr>';
        
        const url = `/members/api/v1/search?q=${encodeURIComponent(query)}&route=manage_members&page=${page}&per_page=${perPage}`;
        
        fetch(url, {
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.getElementById('members-table-body');
                tbody.innerHTML = ''; // Clear the table body
                
                if (data.members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="has-text-centered has-text-grey">No members found.</td></tr>';
                } else {
                    data.members.forEach(member => {
                    const row = document.createElement('tr');
                    const roles = member.roles.map(role => role.name).join(', '); // Combine role names
                    
                    // Create cells and set textContent to prevent XSS
                    const cells = [
                        `${member.firstname} ${member.lastname}`,
                        member.gender || '', // Handle null/undefined gender
                        member.status,
                        member.last_seen,
                        member.lockout ? 'Yes' : 'No',
                        roles
                    ];
                    
                    cells.forEach(cellText => {
                        const cell = document.createElement('td');
                        cell.textContent = cellText; // Use textContent instead of innerHTML
                        row.appendChild(cell);
                    });
                    
                    row.dataset.memberId = member.id; // Store the member ID
                    row.addEventListener('click', () => {
                        window.location.href = `/members/admin/edit_member/${member.id}`;
                    });
                        tbody.appendChild(row);
                    });
                }
                
                // Update pagination
                updatePagination(data.pagination);
            })
            .catch(error => {
                console.error('Error searching members:', error);
                const tbody = document.getElementById('members-table-body');
                tbody.innerHTML = '<tr><td colspan="6" class="has-text-centered has-text-danger">Error loading search results. Please try again.</td></tr>';
                
                // Clear pagination on error
                document.getElementById('pagination-container').innerHTML = '';
            });
    }
    
    function updatePagination(paginationData) {
        const container = document.getElementById('pagination-container');
        
        if (paginationData.total_pages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let paginationHTML = '<nav class="pagination is-centered" role="navigation" aria-label="pagination">';
        
        // Previous button
        if (paginationData.has_prev) {
            paginationHTML += `<a class="pagination-previous" onclick="loadMembers('${currentQuery}', ${paginationData.prev_num})">Previous</a>`;
        } else {
            paginationHTML += '<a class="pagination-previous" disabled>Previous</a>';
        }
        
        // Next button
        if (paginationData.has_next) {
            paginationHTML += `<a class="pagination-next" onclick="loadMembers('${currentQuery}', ${paginationData.next_num})">Next</a>`;
        } else {
            paginationHTML += '<a class="pagination-next" disabled>Next</a>';
        }
        
        // Page numbers
        paginationHTML += '<ul class="pagination-list">';
        
        // Always show first page
        if (paginationData.page > 3) {
            paginationHTML += '<li><a class="pagination-link" onclick="loadMembers(\''+currentQuery+'\', 1)">1</a></li>';
            if (paginationData.page > 4) {
                paginationHTML += '<li><span class="pagination-ellipsis">&hellip;</span></li>';
            }
        }
        
        // Show pages around current page
        for (let i = Math.max(1, paginationData.page - 2); i <= Math.min(paginationData.total_pages, paginationData.page + 2); i++) {
            if (i === paginationData.page) {
                paginationHTML += `<li><a class="pagination-link is-current" aria-label="Goto page ${i}" aria-current="page">${i}</a></li>`;
            } else {
                paginationHTML += `<li><a class="pagination-link" onclick="loadMembers('${currentQuery}', ${i})">${i}</a></li>`;
            }
        }
        
        // Always show last page
        if (paginationData.page < paginationData.total_pages - 2) {
            if (paginationData.page < paginationData.total_pages - 3) {
                paginationHTML += '<li><span class="pagination-ellipsis">&hellip;</span></li>';
            }
            paginationHTML += `<li><a class="pagination-link" onclick="loadMembers('${currentQuery}', ${paginationData.total_pages})">${paginationData.total_pages}</a></li>`;
        }
        
        paginationHTML += '</ul></nav>';
        
        // Add result count info
        const start = (paginationData.page - 1) * paginationData.per_page + 1;
        const end = Math.min(paginationData.page * paginationData.per_page, paginationData.total);
        paginationHTML += `<p class="has-text-centered has-text-grey mt-3">Showing ${start}-${end} of ${paginationData.total} members</p>`;
        
        container.innerHTML = paginationHTML;
    }

    // Load all members when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadMembers();
    });

    // Set up search functionality with debouncing
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', function () {
        clearTimeout(searchTimeout);
        const query = this.value;
        
        // Debounce search to avoid too many requests
        searchTimeout = setTimeout(() => {
            loadMembers(query, 1); // Reset to page 1 for new searches
        }, 300);
    });
</script>
{% endblock %}