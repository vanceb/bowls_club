{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="title">Manage Roles</h1>
    <p class="subtitle">Admin interface for managing user roles</p>
    
    <!-- User Roles Management Section -->
    <div class="box">
        <h2 class="title is-4">
            <span class="icon has-text-primary">
                <i class="fas fa-users"></i>
            </span>
            User Role Assignments
        </h2>
        <p class="subtitle is-6 has-text-grey">Manage role assignments for users</p>
        
        {% if users_with_roles %}
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Current Roles</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users_with_roles %}
                    <tr>
                        <td>
                            <div class="media">
                                <div class="media-content">
                                    <p class="has-text-weight-semibold">
                                        {{ user.firstname }} {{ user.lastname }}
                                        {% if user.is_admin %}
                                        <span class="tag is-danger is-small">Admin</span>
                                        {% endif %}
                                    </p>
                                    <p class="has-text-grey is-size-7">{{ user.username }}</p>
                                </div>
                            </div>
                        </td>
                        <td>{{ user.email }}</td>
                        <td>
                            <div class="tags">
                                {% for role in user.roles %}
                                {% if role.name == 'User Manager' %}
                                <span class="tag is-primary">
                                    {{ role.name }}
                                    <button class="delete is-small" onclick="removeUserRole({{ user.id }}, {{ role.id }}, '{{ user.firstname }} {{ user.lastname }}', '{{ role.name }}')"></button>
                                </span>
                                {% elif role.name == 'Content Manager' %}
                                <span class="tag is-success">
                                    {{ role.name }}
                                    <button class="delete is-small" onclick="removeUserRole({{ user.id }}, {{ role.id }}, '{{ user.firstname }} {{ user.lastname }}', '{{ role.name }}')"></button>
                                </span>
                                {% elif role.name == 'Event Manager' %}
                                <span class="tag is-warning">
                                    {{ role.name }}
                                    <button class="delete is-small" onclick="removeUserRole({{ user.id }}, {{ role.id }}, '{{ user.firstname }} {{ user.lastname }}', '{{ role.name }}')"></button>
                                </span>
                                {% else %}
                                <span class="tag is-info">
                                    {{ role.name }}
                                    <button class="delete is-small" onclick="removeUserRole({{ user.id }}, {{ role.id }}, '{{ user.firstname }} {{ user.lastname }}', '{{ role.name }}')"></button>
                                </span>
                                {% endif %}
                                {% endfor %}
                                {% if not user.roles %}
                                <span class="has-text-grey">No roles assigned</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <button class="button is-primary is-small" onclick="addUserRole({{ user.id }}, '{{ user.firstname }} {{ user.lastname }}')">
                                <span class="icon">
                                    <i class="fas fa-plus"></i>
                                </span>
                                <span>Add Role</span>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="notification is-info">
            <p>No users currently have roles assigned.</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Roles Management Section -->
    <div class="box">
        <div class="level">
            <div class="level-left">
                <div class="level-item">
                    <h2 class="title is-4">Roles ({{ roles|length }})</h2>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <button class="button is-primary" onclick="addRole()">
                        <span class="icon">
                            <i class="fas fa-plus"></i>
                        </span>
                        <span>Add Role</span>
                    </button>
                </div>
            </div>
        </div>
        
        {% if roles %}
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                    <tr>
                        <th>Role Name</th>
                        <th>Members</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for role in roles %}
                    {% set is_core_role = role.name in config.CORE_ROLES %}
                    <tr>
                        <td>
                            {{ role.name }}
                            {% if is_core_role %}
                            <span class="tag is-warning is-small">
                                <span class="icon">
                                    <i class="fas fa-shield-alt"></i>
                                </span>
                                <span>Core Role</span>
                            </span>
                            {% endif %}
                        </td>
                        <td>{{ role.members|length }} members</td>
                        <td>
                            <div class="buttons are-small">
                                {% if is_core_role %}
                                <button class="button is-light is-small" disabled title="Core roles cannot be edited">
                                    <span class="icon">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                    <span>Edit</span>
                                </button>
                                <button class="button is-light is-small" disabled title="Core roles cannot be deleted">
                                    <span class="icon">
                                        <i class="fas fa-trash"></i>
                                    </span>
                                    <span>Delete</span>
                                </button>
                                {% else %}
                                <button class="button is-primary is-small" onclick="editRole({{ role.id }}, '{{ role.name }}')">
                                    <span class="icon">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                    <span>Edit</span>
                                </button>
                                <button class="button is-danger is-small" onclick="deleteRole({{ role.id }}, '{{ role.name }}')">
                                    <span class="icon">
                                        <i class="fas fa-trash"></i>
                                    </span>
                                    <span>Delete</span>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="notification is-info">
            <p>No roles found.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Hidden forms for role operations -->
<form method="POST" id="role-form" style="display: none;">
    {{ csrf_form.hidden_tag() }}
    <input type="hidden" name="action" id="form-action">
    <input type="hidden" name="role_id" id="form-role-id">
    <input type="hidden" name="role_name" id="form-role-name">
</form>

<!-- Hidden form for user role operations -->
<form method="POST" id="user-role-form" style="display: none;">
    {{ csrf_form.hidden_tag() }}
    <input type="hidden" name="action" id="user-form-action">
    <input type="hidden" name="user_id" id="user-form-user-id">
    <input type="hidden" name="role_id" id="user-form-role-id">
</form>

<!-- Modal for add/edit role -->
<div class="modal" id="role-modal">
    <div class="modal-background" onclick="closeModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title" id="modal-title">Add Role</p>
            <button class="delete" onclick="closeModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Role Name</label>
                <div class="control">
                    <input class="input" type="text" id="modal-role-name" placeholder="Enter role name">
                </div>
                <p class="help" id="modal-help">Enter a descriptive name for the role.</p>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" id="modal-save-btn" onclick="saveRole()">Save</button>
            <button class="button" onclick="closeModal()">Cancel</button>
        </footer>
    </div>
</div>

<!-- Modal for adding role to user -->
<div class="modal" id="user-role-modal">
    <div class="modal-background" onclick="closeUserRoleModal()"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title" id="user-role-modal-title">Add Role to User</p>
            <button class="delete" onclick="closeUserRoleModal()"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Select Role</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        <select id="user-role-select">
                            <option value="">Choose a role...</option>
                            {% for role in roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <p class="help">Select a role to assign to <span id="selected-user-name"></span>.</p>
            </div>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" onclick="saveUserRole()">Add Role</button>
            <button class="button" onclick="closeUserRoleModal()">Cancel</button>
        </footer>
    </div>
</div>

<script>
let currentAction = '';
let currentRoleId = '';
let currentUserId = '';

function addRole() {
    currentAction = 'create';
    currentRoleId = '';
    document.getElementById('modal-title').textContent = 'Add Role';
    document.getElementById('modal-role-name').value = '';
    document.getElementById('modal-help').textContent = 'Enter a descriptive name for the role.';
    document.getElementById('modal-save-btn').textContent = 'Create';
    document.getElementById('role-modal').classList.add('is-active');
    document.getElementById('modal-role-name').focus();
}

function editRole(roleId, roleName) {
    currentAction = 'rename';
    currentRoleId = roleId;
    document.getElementById('modal-title').textContent = 'Edit Role';
    document.getElementById('modal-role-name').value = roleName;
    document.getElementById('modal-help').textContent = 'Enter the new name for the role.';
    document.getElementById('modal-save-btn').textContent = 'Update';
    document.getElementById('role-modal').classList.add('is-active');
    document.getElementById('modal-role-name').focus();
    document.getElementById('modal-role-name').select();
}

function deleteRole(roleId, roleName) {
    if (confirm(`Are you sure you want to delete the role "${roleName}"?\n\nThis action cannot be undone and will remove this role from all members who have it.`)) {
        document.getElementById('form-action').value = 'delete';
        document.getElementById('form-role-id').value = roleId;
        document.getElementById('form-role-name').value = '';
        document.getElementById('role-form').submit();
    }
}

function saveRole() {
    const roleName = document.getElementById('modal-role-name').value.trim();
    
    if (!roleName) {
        alert('Please enter a role name.');
        return;
    }
    
    document.getElementById('form-action').value = currentAction;
    document.getElementById('form-role-id').value = currentRoleId;
    document.getElementById('form-role-name').value = roleName;
    document.getElementById('role-form').submit();
}

function closeModal() {
    document.getElementById('role-modal').classList.remove('is-active');
}

// Handle ESC key to close modal
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

// Handle Enter key in modal input
document.getElementById('modal-role-name').addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        saveRole();
    }
});

// User role management functions
function addUserRole(userId, userName) {
    currentUserId = userId;
    document.getElementById('selected-user-name').textContent = userName;
    document.getElementById('user-role-select').value = '';
    document.getElementById('user-role-modal').classList.add('is-active');
}

function removeUserRole(userId, roleId, userName, roleName) {
    if (confirm(`Are you sure you want to remove the role "${roleName}" from ${userName}?`)) {
        document.getElementById('user-form-action').value = 'remove_user_role';
        document.getElementById('user-form-user-id').value = userId;
        document.getElementById('user-form-role-id').value = roleId;
        document.getElementById('user-role-form').submit();
    }
}

function saveUserRole() {
    const selectedRoleId = document.getElementById('user-role-select').value;
    
    if (!selectedRoleId) {
        alert('Please select a role.');
        return;
    }
    
    document.getElementById('user-form-action').value = 'add_user_role';
    document.getElementById('user-form-user-id').value = currentUserId;
    document.getElementById('user-form-role-id').value = selectedRoleId;
    document.getElementById('user-role-form').submit();
}

function closeUserRoleModal() {
    document.getElementById('user-role-modal').classList.remove('is-active');
}

// Handle ESC key to close user role modal
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeUserRoleModal();
    }
});
</script>
{% endblock %}