{% extends "base.html" %}

{% block content %}

<div class="container">
    <h1 class="title">Create Booking</h1>
    <form method="POST" action="{{ url_for('create_booking') }}">
        {{ form.hidden_tag() }}
        
        <div class="field">
            <label class="label">Booking Date</label>
            <div class="control">
                {{ form.booking_date(class="input") }}
            </div>
            {% for error in form.booking_date.errors %}
                <p class="help is-danger">{{ error }}</p>
            {% endfor %}
        </div>

        <div class="field">
            <label class="label">Session</label>
            <div class="control">
                <div class="select">
                    {{ form.session() }}
                </div>
            </div>
            {% for error in form.session.errors %}
                <p class="help is-danger">{{ error }}</p>
            {% endfor %}
        </div>

        <div class="field">
            <label class="label">Number of Rinks Needed</label>
            <div class="control">
                {{ form.rink_count(class="input") }}
            </div>
            <p class="help">Enter the number of rinks needed for this booking (1-6)</p>
            <div id="availability-info" class="notification is-hidden">
                <!-- Availability information will be displayed here -->
            </div>
            {% for error in form.rink_count.errors %}
                <p class="help is-danger">{{ error }}</p>
            {% endfor %}
        </div>

        <div class="field">
            <label class="label">Priority</label>
            <div class="control">
                {{ form.priority(class="input") }}
            </div>
            {% for error in form.priority.errors %}
                <p class="help is-danger">{{ error }}</p>
            {% endfor %}
        </div>

        <div class="field">
            <div class="control">
                <button class="button is-primary" type="submit">Submit</button>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bookingDateInput = document.getElementById('booking_date');
    const sessionSelect = document.getElementById('session');
    const rinkCountInput = document.getElementById('rink_count');
    const availabilityInfo = document.getElementById('availability-info');

    // Function to fetch and display availability
    function updateAvailability() {
        const date = bookingDateInput.value;
        const session = sessionSelect.value;
        
        // Only fetch if both date and session are selected
        if (date && session) {
            fetch(`/get_availability/${date}/${session}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayAvailability(data);
                })
                .catch(error => {
                    console.error('Error fetching availability:', error);
                    hideAvailability();
                });
        } else {
            hideAvailability();
        }
    }

    // Function to display availability information
    function displayAvailability(data) {
        const availableRinks = data.available_rinks;
        const bookedRinks = data.booked_rinks;
        const totalRinks = data.total_rinks;
        
        let message = '';
        let notificationClass = '';
        
        if (availableRinks === totalRinks) {
            message = `All ${totalRinks} rinks are available for this session.`;
            notificationClass = 'is-success';
        } else if (availableRinks > 0) {
            message = `${availableRinks} of ${totalRinks} rinks available (${bookedRinks} already booked).`;
            notificationClass = 'is-warning';
        } else {
            message = `This session is fully booked (${bookedRinks}/${totalRinks} rinks).`;
            notificationClass = 'is-danger';
        }
        
        availabilityInfo.innerHTML = `
            <div class="has-text-weight-bold">Availability Status:</div>
            ${message}
        `;
        
        // Remove existing notification classes and add the appropriate one
        availabilityInfo.className = `notification ${notificationClass}`;
        
        // Update the max value for rink count input
        rinkCountInput.setAttribute('max', Math.max(0, availableRinks));
        
        // If current value exceeds available rinks, show warning
        const currentValue = parseInt(rinkCountInput.value) || 0;
        if (currentValue > availableRinks) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'has-text-danger';
            warningDiv.innerHTML = `<br><strong>Warning:</strong> You've requested ${currentValue} rinks, but only ${availableRinks} are available.`;
            availabilityInfo.appendChild(warningDiv);
        }
    }

    // Function to hide availability information
    function hideAvailability() {
        availabilityInfo.className = 'notification is-hidden';
        availabilityInfo.innerHTML = '';
        rinkCountInput.removeAttribute('max');
    }

    // Add event listeners
    bookingDateInput.addEventListener('change', updateAvailability);
    sessionSelect.addEventListener('change', updateAvailability);
    rinkCountInput.addEventListener('input', function() {
        // Re-check availability when rink count changes to show warnings
        if (bookingDateInput.value && sessionSelect.value) {
            updateAvailability();
        }
    });

    // Check availability on page load if values are already set
    if (bookingDateInput.value && sessionSelect.value) {
        updateAvailability();
    }
});
</script>

{% endblock %}