{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Data container for JavaScript -->
    <div id="page-data" 
         data-selected-event-id="{{ selected_event.id if selected_event else '' }}"
         data-selected-event-name="{{ selected_event.name if selected_event else '' }}"
         style="display: none;">
    </div>
    
    <h1 class="title">Events Management</h1>
    
    <!-- Workflow Overview -->
    {% if selected_event %}
    <div class="notification is-info is-light">
        <h4 class="title is-6">
            <span class="icon">
                <i class="fas fa-info-circle"></i>
            </span>
            <span>Event Management Workflow</span>
        </h4>
        <div class="content">
            <p><strong>Understanding Event Teams vs Booking Teams:</strong></p>
            <ul>
                <li><strong>Event Teams</strong> (below) are <em>templates</em> that define the standard teams for this event type</li>
                <li><strong>Booking Teams</strong> are <em>copies</em> of event teams, created automatically when you schedule a game</li>
                <li>Event Managers can make substitutions on booking teams without affecting the original event templates</li>
                <li>This allows you to have consistent team templates while managing game-specific changes</li>
            </ul>
        </div>
    </div>
    {% endif %}
    
    <!-- Event Selection Form -->
    <div class="box">
        <h2 class="subtitle">Select Event</h2>
        <div class="field">
            <div class="control">
                <div class="select is-fullwidth">
                    {{ selection_form.selected_event() }}
                </div>
            </div>
        </div>
    </div>

    <!-- Event Details Form -->
    <div class="box">
        <h2 class="subtitle" id="event-form-title">
            {% if selected_event %}
                Step 1: Edit Event Details
                <span class="tag is-success ml-2">
                    <span class="icon is-small"><i class="fas fa-check"></i></span>
                    <span>Complete</span>
                </span>
            {% else %}
                Step 1: Create New Event
            {% endif %}
        </h2>
        
        <form method="POST" id="event-form">
            {{ event_form.hidden_tag() }}
            {{ event_form.event_id() }}
            
            <div class="field">
                <label class="label">Event Name</label>
                <div class="control">
                    {{ event_form.name(class="input") }}
                </div>
                {% for error in event_form.name.errors %}
                    <p class="help is-danger">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="field">
                <label class="label">Event Type</label>
                <div class="control">
                    <div class="select is-fullwidth">
                        {{ event_form.event_type() }}
                    </div>
                </div>
                {% for error in event_form.event_type.errors %}
                    <p class="help is-danger">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="field-body">
                <div class="field">
                    <label class="label">Gender</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            {{ event_form.gender() }}
                        </div>
                    </div>
                    {% for error in event_form.gender.errors %}
                        <p class="help is-danger">{{ error }}</p>
                    {% endfor %}
                </div>

                <div class="field">
                    <label class="label">Format</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            {{ event_form.format() }}
                        </div>
                    </div>
                    {% for error in event_form.format.errors %}
                        <p class="help is-danger">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>

            <div class="field">
                <label class="label">Scoring</label>
                <div class="control">
                    {{ event_form.scoring(class="input") }}
                </div>
                <p class="help">Optional scoring method or format (e.g., "Best of 3 sets", "21 points")</p>
                {% for error in event_form.scoring.errors %}
                    <p class="help is-danger">{{ error }}</p>
                {% endfor %}
            </div>

            <div class="field">
                <label class="label">Event Managers</label>
                <div class="control">
                    {{ event_form.event_managers() }}
                </div>
                <p class="help">Select one or more people responsible for organizing this event</p>
                {% for error in event_form.event_managers.errors %}
                    <p class="help is-danger">{{ error }}</p>
                {% endfor %}
            </div>


            <div class="field">
                <div class="control">
                    {{ event_form.submit(class="button is-primary") }}
                    {% if selected_event %}
                        <a href="{{ url_for('admin.manage_events') }}" class="button is-light">Cancel</a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>

    <!-- Pool Management Section -->
    {% if selected_event %}
    <div class="box" id="pool-section">
        <div class="level">
            <div class="level-left">
                <div>
                    <h2 class="subtitle">
                        Step 1.5: Pool Registration for {{ selected_event.name }}
                        {% if selected_event.has_pool_enabled() %}
                            <span class="tag is-info ml-2">
                                <span class="icon is-small"><i class="fas fa-swimming-pool"></i></span>
                                <span>Pool Enabled</span>
                            </span>
                            {% if selected_event.is_pool_open() %}
                                <span class="tag is-success ml-1">
                                    <span class="icon is-small"><i class="fas fa-door-open"></i></span>
                                    <span>Open</span>
                                </span>
                            {% else %}
                                <span class="tag is-warning ml-1">
                                    <span class="icon is-small"><i class="fas fa-door-closed"></i></span>
                                    <span>Closed</span>
                                </span>
                            {% endif %}
                        {% else %}
                            <span class="tag is-light ml-2">
                                <span class="icon is-small"><i class="fas fa-ban"></i></span>
                                <span>No Pool</span>
                            </span>
                        {% endif %}
                    </h2>
                    {% set workflow_status = selected_event.get_workflow_status() %}
                    <p class="help">
                        Workflow Stage: <strong>{{ workflow_status.stage.replace('_', ' ').title() }}</strong>
                        {% if workflow_status.pool_enabled %}
                            • {{ workflow_status.pool_members }} registered 
                            • {{ workflow_status.available_members }} available for teams
                        {% endif %}
                    </p>
                </div>
            </div>
            <div class="level-right">
                {% if not selected_event.has_pool_enabled() %}
                    <form method="POST" action="{{ url_for('admin.create_event_pool', event_id=selected_event.id) }}" style="display: inline;">
                        {{ event_form.csrf_token }}
                        <button type="submit" class="button is-primary">
                            <span class="icon">
                                <i class="fas fa-plus"></i>
                            </span>
                            <span>Enable Pool Registration</span>
                        </button>
                    </form>
                {% else %}
                    <div class="field is-grouped">
                        {% if selected_event.is_pool_open() %}
                            <form method="POST" action="{{ url_for('admin.toggle_event_pool', event_id=selected_event.id) }}" style="display: inline;">
                                {{ event_form.csrf_token }}
                                <button type="submit" class="button is-warning">
                                    <span class="icon">
                                        <i class="fas fa-door-closed"></i>
                                    </span>
                                    <span>Close Registration</span>
                                </button>
                            </form>
                        {% else %}
                            <form method="POST" action="{{ url_for('admin.toggle_event_pool', event_id=selected_event.id) }}" style="display: inline;">
                                {{ event_form.csrf_token }}
                                <button type="submit" class="button is-success">
                                    <span class="icon">
                                        <i class="fas fa-door-open"></i>
                                    </span>
                                    <span>Open Registration</span>
                                </button>
                            </form>
                        {% endif %}
                    
                    <div class="dropdown is-hoverable ml-2">
                            <div class="dropdown-trigger">
                                <button class="button is-info" aria-haspopup="true" aria-controls="pool-actions-menu">
                                    <span>Pool Actions</span>
                                    <span class="icon is-small">
                                        <i class="fas fa-angle-down" aria-hidden="true"></i>
                                    </span>
                                </button>
                            </div>
                            <div class="dropdown-menu" id="pool-actions-menu" role="menu">
                                <div class="dropdown-content">
                                    {% if workflow_status.pool_members > 0 %}
                                        <a href="#" class="dropdown-item" onclick="showAutoSelectModal()">
                                            <span class="icon is-small">
                                                <i class="fas fa-magic"></i>
                                            </span>
                                            Auto-Select Members
                                        </a>
                                        <a href="#" class="dropdown-item" onclick="showBulkStatusModal()">
                                            <span class="icon is-small">
                                                <i class="fas fa-users-cog"></i>
                                            </span>
                                            Bulk Status Update
                                        </a>
                                        <hr class="dropdown-divider">
                                    {% endif %}
                                    {% if workflow_status.available_members >= 4 %}
                                        <a href="#" class="dropdown-item" onclick="showCreateTeamsModal()">
                                            <span class="icon is-small">
                                                <i class="fas fa-users"></i>
                                            </span>
                                            Create Teams from Pool
                                        </a>
                                    {% endif %}
                                    {% if workflow_status.teams_with_members > 0 %}
                                        <a href="#" class="dropdown-item" onclick="showCreateBookingModal()">
                                            <span class="icon is-small">
                                                <i class="fas fa-calendar-plus"></i>
                                            </span>
                                            Create Booking from Teams
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        {% if selected_event.has_pool_enabled() %}
            <!-- Pool Members Display -->
            <div class="content">
                {% if pool_registrations %}
                    <h4 class="title is-6">Pool Members ({{ pool_registrations | length }})</h4>
                    
                    <!-- Status Explanation -->
                    <div class="message is-info mb-4">
                        <div class="message-body">
                            <p class="has-text-weight-semibold mb-2">Pool Status Guide:</p>
                            <div class="content is-small">
                                <ul class="mb-1">
                                    <li><span class="tag is-info is-small">Registered</span> - Member is available for team selection</li>
                                    <li><span class="tag is-primary is-small">Selected</span> - Member has been placed in a team</li>
                                </ul>
                                <p class="is-size-7 has-text-grey">Members who withdraw are removed from the pool. Only "Registered" members can be selected for teams.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table is-fullwidth is-striped">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Status</th>
                                    <th>Registered</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for registration in pool_registrations %}
                                <tr>
                                    <td>
                                        <strong>{{ registration.member.firstname }} {{ registration.member.lastname }}</strong>
                                        {% if registration.member.username %}
                                            <br><small class="has-text-grey">{{ registration.member.username }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="tag 
                                            {% if registration.status == 'registered' %}is-info
                                            {% elif registration.status == 'selected' %}is-primary
                                            {% endif %}">
                                            {{ registration.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ registration.registered_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </td>
                                    <td>
                                        {% if registration.status == 'selected' %}
                                            <form method="POST" action="{{ url_for('admin.update_registration_status', registration_id=registration.id) }}" style="display: inline;">
                                                {{ event_form.csrf_token }}
                                                <input type="hidden" name="status" value="registered">
                                                <button type="submit" class="button is-small is-warning" title="Return member to pool (remove from team)">
                                                    <span class="icon is-small">
                                                        <i class="fas fa-undo"></i>
                                                    </span>
                                                    <span>Return to Pool</span>
                                                </button>
                                            </form>
                                        {% else %}
                                            <span class="has-text-grey is-size-7">Ready for selection</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="notification is-info">
                        <p><strong>No pool registrations yet.</strong></p>
                        <p>Members can register via the "Upcoming Events" page when the pool is open.</p>
                    </div>
                {% endif %}
                
                <!-- Add Member to Pool Form -->
                <div class="mt-4">
                    <h5 class="title is-6">Add Member to Pool</h5>
                    <form method="POST" action="{{ url_for('admin.add_member_to_pool', event_id=selected_event.id) }}">
                        {{ event_form.csrf_token }}
                        <div class="field has-addons">
                            <div class="control is-expanded">
                                <div class="select is-fullwidth">
                                    <select name="member_id" required>
                                        <option value="">Select a member to add...</option>
                                        {% for member in available_members_for_pool %}
                                            <option value="{{ member.id }}">{{ member.firstname }} {{ member.lastname }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="control">
                                <button type="submit" class="button is-primary">
                                    <span class="icon">
                                        <i class="fas fa-user-plus"></i>
                                    </span>
                                    <span>Add to Pool</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Workflow Progress Indicator -->
            <div class="notification is-light">
                <h5 class="title is-6">
                    <span class="icon">
                        <i class="fas fa-route"></i>
                    </span>
                    Workflow Progress
                </h5>
                <div class="content">
                    <div class="columns is-mobile">
                        <div class="column">
                            <div class="has-text-centered">
                                <span class="icon is-large {% if workflow_status.pool_members > 0 %}has-text-success{% else %}has-text-grey-light{% endif %}">
                                    <i class="fas fa-2x fa-users"></i>
                                </span>
                                <p class="is-size-7">
                                    <strong>{{ workflow_status.pool_members }}</strong><br>
                                    Registered
                                </p>
                            </div>
                        </div>
                        <div class="column">
                            <div class="has-text-centered">
                                <span class="icon is-large {% if workflow_status.available_members > 0 %}has-text-success{% else %}has-text-grey-light{% endif %}">
                                    <i class="fas fa-2x fa-user-check"></i>
                                </span>
                                <p class="is-size-7">
                                    <strong>{{ workflow_status.available_members }}</strong><br>
                                    Available
                                </p>
                            </div>
                        </div>
                        <div class="column">
                            <div class="has-text-centered">
                                <span class="icon is-large {% if workflow_status.teams_count > 0 %}has-text-success{% else %}has-text-grey-light{% endif %}">
                                    <i class="fas fa-2x fa-users-cog"></i>
                                </span>
                                <p class="is-size-7">
                                    <strong>{{ workflow_status.teams_count }}</strong><br>
                                    Teams
                                </p>
                            </div>
                        </div>
                        <div class="column">
                            <div class="has-text-centered">
                                <span class="icon is-large {% if workflow_status.bookings_count > 0 %}has-text-success{% else %}has-text-grey-light{% endif %}">
                                    <i class="fas fa-2x fa-calendar-check"></i>
                                </span>
                                <p class="is-size-7">
                                    <strong>{{ workflow_status.bookings_count }}</strong><br>
                                    Bookings
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {% set can_create_teams, teams_message = selected_event.can_create_teams_from_pool() %}
                    {% set can_create_booking, booking_message = selected_event.can_create_booking_from_teams() %}
                    
                    <div class="tags">
                        {% if workflow_status.stage == 'awaiting_registrations' %}
                            <span class="tag is-warning">
                                <span class="icon is-small"><i class="fas fa-clock"></i></span>
                                <span>Awaiting member registrations</span>
                            </span>
                        {% elif workflow_status.stage == 'ready_for_selection' %}
                            <span class="tag is-info">
                                <span class="icon is-small"><i class="fas fa-hand-pointer"></i></span>
                                <span>Ready for member selection</span>
                            </span>
                        {% elif workflow_status.stage == 'ready_for_teams' %}
                            <span class="tag is-primary">
                                <span class="icon is-small"><i class="fas fa-users"></i></span>
                                <span>{{ teams_message }}</span>
                            </span>
                        {% elif workflow_status.stage == 'ready_for_booking' %}
                            <span class="tag is-success">
                                <span class="icon is-small"><i class="fas fa-calendar-plus"></i></span>
                                <span>{{ booking_message }}</span>
                            </span>
                        {% elif workflow_status.stage == 'complete' %}
                            <span class="tag is-success">
                                <span class="icon is-small"><i class="fas fa-check-circle"></i></span>
                                <span>Workflow complete</span>
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Teams Section -->
    <div class="box" id="teams-section" {% if not selected_event %}style="opacity: 0.6;"{% endif %}>
        <div class="level">
            <div class="level-left">
                <div>
                    <h2 class="subtitle" id="teams-title">
                        {% if selected_event %}
                            Step 2: Teams for {{ selected_event.name }}
                        {% else %}
                            Step 2: Event Teams
                        {% endif %}
                        {% if selected_event %}
                            {% if selected_event.has_teams() %}
                                <span class="tag is-success ml-2">
                                    <span class="icon is-small"><i class="fas fa-check"></i></span>
                                    <span>{{ selected_event.event_teams | length }} team(s)</span>
                                </span>
                            {% else %}
                                <span class="tag is-warning ml-2">
                                    <span class="icon is-small"><i class="fas fa-exclamation"></i></span>
                                    <span>No teams</span>
                                </span>
                            {% endif %}
                        {% endif %}
                    </h2>
                    {% if not selected_event %}
                        <p class="help">Create an event first to manage teams</p>
                    {% elif not selected_event.has_teams() %}
                        <p class="help">Add at least one team before creating bookings</p>
                    {% endif %}
                </div>
            </div>
            <div class="level-right">
                <a href="#" id="add-team-btn" class="button is-success hidden-initially">
                    <span class="icon">
                        <i class="fas fa-plus"></i>
                    </span>
                    <span>Add Team</span>
                </a>
            </div>
        </div>
        
        <!-- Teams List -->
        {% if event_teams %}
        <div class="columns is-multiline">
            {% for team in event_teams %}
            <div class="column is-half">
                <div class="card">
                    <div class="card-header">
                        <p class="card-header-title">
                            {{ team.team_name }}
                            <span class="tag is-light ml-2">
                                {% if selected_event %}
                                    {{ team_positions.get(selected_event.format, []) | length }} players
                                {% endif %}
                            </span>
                        </p>
                        <div class="card-header-icon">
                            <a href="{{ url_for('admin.edit_event_team', team_id=team.id) }}" 
                               class="button is-small is-info mr-1"
                               aria-label="Edit team">
                                <span class="icon is-small">
                                    <i class="fas fa-edit"></i>
                                </span>
                            </a>
                            <button class="button is-small is-danger delete-team-btn" 
                                    data-team-id="{{ team.id }}" 
                                    data-team-name="{{ team.team_name }}"
                                    aria-label="Delete team">
                                <span class="icon is-small">
                                    <i class="fas fa-trash"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        {% if team.team_members %}
                            <div class="content">
                                {% for member in team.team_members %}
                                <div class="field">
                                    <label class="label is-small">{{ member.position }}</label>
                                    <p>{{ member.member.firstname }} {{ member.member.lastname }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="content">
                                <p class="has-text-grey">
                                    <em>No players assigned yet</em>
                                </p>
                                {% if selected_event and team_positions.get(selected_event.format) %}
                                <p class="is-size-7">
                                    Positions needed: 
                                    {% for position in team_positions.get(selected_event.format, []) %}
                                        <span class="tag is-small">{{ position }}</span>
                                    {% endfor %}
                                </p>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="notification is-info">
            <p><strong>No teams found for this event.</strong></p>
            <p>Use the "Add Team" button above to create your first team. Each team will need to be assigned players for the {{ selected_event.get_format_name() if selected_event else 'selected' }} format.</p>
            <p class="is-size-7 mt-2"><strong>Note:</strong> These are template teams. When you create bookings, copies of these teams will be made for each game, allowing individual substitutions without affecting the original templates.</p>
        </div>
        {% endif %}
        
        <!-- Default message when no event is selected -->
        <div id="no-teams-message" class="notification is-info">
            <p>Select an event from the dropdown above to view and manage its teams.</p>
        </div>
    </div>

    <!-- Bookings Section -->
    <div class="box" id="bookings-section" {% if not can_create_bookings %}style="opacity: 0.6;"{% endif %}>
        <div class="level">
            <div class="level-left">
                <div>
                    <h2 class="subtitle" id="bookings-title">
                        {% if selected_event %}
                            Step 3: Bookings for {{ selected_event.name }}
                        {% else %}
                            Step 3: Event Bookings
                        {% endif %}
                        {% if selected_event and event_bookings %}
                            <span class="tag is-success ml-2">
                                <span class="icon is-small"><i class="fas fa-check"></i></span>
                                <span>{{ event_bookings | length }} booking(s)</span>
                            </span>
                        {% endif %}
                    </h2>
                    {% if not selected_event %}
                        <p class="help">Create an event and add teams first</p>
                    {% elif not can_create_bookings %}
                        <p class="help">Add at least one team before creating bookings</p>
                    {% elif not event_bookings %}
                        <p class="help">Schedule games using your event teams</p>
                    {% endif %}
                </div>
            </div>
            <div class="level-right">
                <button id="toggle-booking-form" 
                        class="button {% if can_create_bookings %}is-success{% else %}is-success{% endif %} hidden-initially"
                        {% if not can_create_bookings %}disabled title="Add teams first before creating bookings"{% endif %}>
                    <span class="icon">
                        <i class="fas fa-plus"></i>
                    </span>
                    <span>Add Booking</span>
                </button>
            </div>
        </div>
        
        <!-- Add Booking Form (initially hidden) -->
        <div id="booking-form-section" class="box is-hidden booking-form-bg">
            <h3 class="subtitle is-5">Create New Booking</h3>
            <form method="POST" id="booking-form">
                {{ booking_form.hidden_tag() }}
                <input type="hidden" name="event_id" value="{{ selected_event.id }}">
                
                <div class="columns">
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Booking Date</label>
                            <div class="control">
                                {{ booking_form.booking_date(class="input") }}
                            </div>
                            {% for error in booking_form.booking_date.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Session</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    {{ booking_form.session() }}
                                </div>
                            </div>
                            {% for error in booking_form.session.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="columns">
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Number of Rinks Needed</label>
                            <div class="control">
                                {{ booking_form.rink_count(class="input") }}
                            </div>
                            <p class="help">Enter the number of rinks needed for this booking (1-6)</p>
                            <div id="booking-availability-info" class="notification is-hidden">
                                <!-- Availability information will be displayed here -->
                            </div>
                            {% for error in booking_form.rink_count.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Priority</label>
                            <div class="control">
                                {{ booking_form.priority(class="input") }}
                            </div>
                            {% for error in booking_form.priority.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="columns">
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Opposition Team</label>
                            <div class="control">
                                {{ booking_form.vs(class="input", placeholder="e.g., Riverdale Bowls Club") }}
                            </div>
                            {% for error in booking_form.vs.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="column is-half">
                        <div class="field">
                            <label class="label">Venue</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    {{ booking_form.home_away() }}
                                </div>
                            </div>
                            {% for error in booking_form.home_away.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="field is-grouped">
                    <div class="control">
                        <button type="submit" name="create_booking" id="create-booking-btn" class="button is-primary">
                            <span class="icon is-hidden" id="booking-loading-icon">
                                <i class="fas fa-spinner fa-pulse"></i>
                            </span>
                            <span id="booking-btn-text">Create Booking</span>
                        </button>
                    </div>
                    <div class="control">
                        <button type="button" id="cancel-booking" class="button is-light">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Bookings List -->
        {% if can_create_bookings and not event_bookings %}
        <div class="notification is-success is-light">
            <p><strong>Ready to schedule games!</strong></p>
            <p>Your event teams are set up. When you create a booking, these teams will be automatically copied and can be managed separately for each scheduled game.</p>
        </div>
        {% endif %}
        
        {% if event_bookings %}
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
                <tbody>
                    {% for booking in event_bookings %}
                    <tr id="booking-row-{{ booking.id }}">
                        <td>
                            <div class="is-flex is-flex-wrap-wrap is-align-items-center">
                                <span class="mr-2 mb-1"><strong>{{ booking.booking_date.strftime('%Y-%m-%d') }}</strong></span>
                                <span class="mr-2 mb-1">
                                    {% set sessions = config['DAILY_SESSIONS'] %}
                                    {{ sessions.get(booking.session, 'Unknown') }}
                                </span>
                                <span class="mr-2 mb-1">{{ booking.rink_count }} rink{{ 's' if booking.rink_count != 1 else '' }}</span>
                                {% if booking.priority %}
                                <span class="has-text-weight-semibold mr-2 mb-1">[{{ booking.priority }}]</span>
                                {% endif %}
                                {% if booking.vs %}
                                <span class="mr-2 mb-1">vs {{ booking.vs }}</span>
                                {% endif %}
                                {% if booking.home_away %}
                                <span class="has-text-grey mr-2 mb-1">
                                    ({% for key, value in config.get('HOME_AWAY_OPTIONS', {}).items() %}
                                        {% if value == booking.home_away %}{{ key }}{% endif %}
                                    {% endfor %})
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <td width="200">
                            <div class="is-flex is-justify-content-flex-end is-align-items-center">
                                <a href="{{ url_for('admin.manage_teams', booking_id=booking.id) }}" 
                                   class="button is-small is-primary mr-1">
                                    <span class="icon"><i class="fas fa-users"></i></span>
                                    <span class="is-hidden-mobile">Teams</span>
                                </a>
                                <button class="button is-small is-info edit-booking-btn mr-1" 
                                        data-booking-id="{{ booking.id }}">
                                    <span class="icon"><i class="fas fa-edit"></i></span>
                                    <span class="is-hidden-mobile">Edit</span>
                                </button>
                                <button class="button is-small is-danger delete-booking-btn" 
                                        data-booking-id="{{ booking.id }}">
                                    <span class="icon"><i class="fas fa-trash"></i></span>
                                    <span class="is-hidden-mobile">Delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    
                    <!-- Inline Edit Form (initially hidden) -->
                    <tr id="booking-edit-row-{{ booking.id }}" class="booking-edit-row is-hidden">
                        <td colspan="2">
                            <div class="box has-background-light" style="margin: 0.5rem 0;">
                                <h4 class="title is-6">Edit Booking</h4>
                                <form method="POST" class="booking-edit-form" data-booking-id="{{ booking.id }}">
                                    {{ booking_form.hidden_tag() }}
                                    <input type="hidden" name="booking_id" value="{{ booking.id }}">
                                    <input type="hidden" name="event_id" value="{{ selected_event.id }}">
                                    
                                    <div class="columns is-mobile">
                                        <div class="column">
                                            <div class="field">
                                                <label class="label is-small">Date</label>
                                                <div class="control">
                                                    <input type="date" name="booking_date" class="input is-small" 
                                                           value="{{ booking.booking_date.strftime('%Y-%m-%d') }}" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column">
                                            <div class="field">
                                                <label class="label is-small">Session</label>
                                                <div class="control">
                                                    <div class="select is-small is-fullwidth">
                                                        <select name="session" required>
                                                            {% for session_id, session_name in config['DAILY_SESSIONS'].items() %}
                                                            <option value="{{ session_id }}" 
                                                                    {% if booking.session == session_id %}selected{% endif %}>
                                                                {{ session_name }}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column">
                                            <div class="field">
                                                <label class="label is-small">Rinks</label>
                                                <div class="control">
                                                    <input type="number" name="rink_count" class="input is-small" 
                                                           value="{{ booking.rink_count }}" min="1" max="6" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="columns is-mobile">
                                        <div class="column">
                                            <div class="field">
                                                <label class="label is-small">Priority</label>
                                                <div class="control">
                                                    <input type="text" name="priority" class="input is-small" 
                                                           value="{{ booking.priority or '' }}" maxlength="50">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column">
                                            <div class="field">
                                                <label class="label is-small">Opposition Team</label>
                                                <div class="control">
                                                    <input type="text" name="vs" class="input is-small" 
                                                           value="{{ booking.vs or '' }}" maxlength="128" 
                                                           placeholder="e.g., Riverdale Bowls Club">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column">
                                            <div class="field">
                                                <label class="label is-small">Venue</label>
                                                <div class="control">
                                                    <div class="select is-small is-fullwidth">
                                                        <select name="home_away">
                                                            <option value="">Select venue...</option>
                                                            {% for key, value in config.get('HOME_AWAY_OPTIONS', {}).items() %}
                                                            <option value="{{ value }}" 
                                                                    {% if booking.home_away == value %}selected{% endif %}>
                                                                {{ key }}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="field is-grouped">
                                        <div class="control">
                                            <button type="submit" name="update_booking" 
                                                    class="button is-small is-success">
                                                <span class="icon"><i class="fas fa-check"></i></span>
                                                <span>Save</span>
                                            </button>
                                        </div>
                                        <div class="control">
                                            <button type="button" class="button is-small is-light cancel-edit-btn">
                                                <span class="icon"><i class="fas fa-times"></i></span>
                                                <span>Cancel</span>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="notification is-info">
            <p>No bookings found for this event. Click "Add Booking" to create the first booking.</p>
        </div>
        {% endif %}
        <!-- Default message when no event is selected -->
        <div id="no-bookings-message" class="notification is-info">
            <p>Select an event from the dropdown above to view and manage its bookings.</p>
        </div>
    </div>
    {% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scroll helper function
    function scrollToSection(sectionId, offset = 100) {
        const section = document.getElementById(sectionId);
        if (section) {
            const yPosition = section.offsetTop - offset;
            window.scrollTo({
                top: yPosition,
                behavior: 'smooth'
            });
        }
    }
    
    // Disable browser's automatic scroll restoration
    if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
    }
    
    // Preserve scroll position during page reloads
    window.addEventListener('beforeunload', function() {
        sessionStorage.setItem('scrollPosition', window.pageYOffset);
    });
    
    // Check URL parameters for navigation hints after form submission
    const urlParams = new URLSearchParams(window.location.search);
    const scrollTo = urlParams.get('scroll_to');
    if (scrollTo) {
        // Immediately scroll to prevent jump, then smooth scroll
        const section = document.getElementById(scrollTo);
        if (section) {
            const targetPosition = section.offsetTop - 100;
            window.scrollTo(0, targetPosition);
            // Clean up URL without causing reload
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + window.location.search.replace(/[&?]scroll_to=[^&]*/g, '');
            window.history.replaceState({}, '', cleanUrl);
        }
    } else {
        // Restore previous scroll position if no specific target
        const savedPosition = sessionStorage.getItem('scrollPosition');
        if (savedPosition) {
            window.scrollTo(0, parseInt(savedPosition));
            sessionStorage.removeItem('scrollPosition');
        }
    }
    
    const eventSelect = document.getElementById('selected_event');
    const eventForm = document.getElementById('event-form');
    const eventIdInput = document.getElementById('event_id');
    const nameInput = document.getElementById('name');
    const typeSelect = document.getElementById('event_type');
    
    // Booking form elements
    const toggleBookingFormBtn = document.getElementById('toggle-booking-form');
    const bookingFormSection = document.getElementById('booking-form-section');
    const cancelBookingBtn = document.getElementById('cancel-booking');
    const bookingDateInput = document.getElementById('booking_date');
    const bookingSessionSelect = document.getElementById('session');
    const bookingRinkCountInput = document.getElementById('rink_count');
    const bookingAvailabilityInfo = document.getElementById('booking-availability-info');

    // Sync dropdown with selected event on page load (when loaded via URL parameter)
    const pageData = document.getElementById('page-data');
    const selectedEventId = pageData.dataset.selectedEventId;
    const selectedEventName = pageData.dataset.selectedEventName;
    
    if (selectedEventId && eventSelect) {
        eventSelect.value = selectedEventId;
        // Also update the UI elements for selected event
        const eventFormTitle = document.getElementById('event-form-title');
        const bookingsTitle = document.getElementById('bookings-title');
        const noBookingsMessage = document.getElementById('no-bookings-message');
        const toggleBookingBtn = document.getElementById('toggle-booking-form');
        
        if (eventFormTitle) eventFormTitle.textContent = `Edit Event: ${selectedEventName}`;
        if (bookingsTitle) bookingsTitle.textContent = `Bookings for ${selectedEventName}`;
        if (noBookingsMessage) noBookingsMessage.style.display = 'none';
        if (toggleBookingBtn) toggleBookingBtn.style.display = 'inline-flex';
        
        // Update teams section
        const teamsTitle = document.getElementById('teams-title');
        const noTeamsMessage = document.getElementById('no-teams-message');
        const addTeamBtn = document.getElementById('add-team-btn');
        
        if (teamsTitle) teamsTitle.textContent = `Teams for ${selectedEventName}`;
        if (noTeamsMessage) noTeamsMessage.style.display = 'none';
        if (addTeamBtn) addTeamBtn.style.display = 'inline-flex';
    }

    // Handle event selection change
    eventSelect.addEventListener('change', function() {
        const eventId = this.value;
        const eventFormTitle = document.getElementById('event-form-title');
        const bookingsTitle = document.getElementById('bookings-title');
        const noBookingsMessage = document.getElementById('no-bookings-message');
        const toggleBookingBtn = document.getElementById('toggle-booking-form');
        
        if (eventId == 0) {
            // Clear form for new event
            eventIdInput.value = '';
            nameInput.value = '';
            typeSelect.value = '';
            
            // Clear new fields
            const genderSelect = document.getElementById('gender');
            const formatSelect = document.getElementById('format');
            const scoringInput = document.getElementById('scoring');
            const eventManagersCheckboxes = document.querySelectorAll('input[name="event_managers"]');
            
            if (genderSelect) genderSelect.value = '4'; // Default to "Open"
            if (formatSelect) formatSelect.value = '5'; // Default to "Fours - 2 Wood"
            if (scoringInput) scoringInput.value = '';
            
            // Clear event managers checkboxes
            if (eventManagersCheckboxes) {
                eventManagersCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            
            eventFormTitle.textContent = 'Step 1: Create New Event';
            
            // Hide bookings section content
            bookingsTitle.textContent = 'Step 3: Event Bookings';
            if (noBookingsMessage) noBookingsMessage.style.display = 'block';
            if (toggleBookingBtn) toggleBookingBtn.style.display = 'none';
            
            // Hide existing bookings table
            const bookingsTable = document.querySelector('.table-container');
            if (bookingsTable) bookingsTable.style.display = 'none';
            
            // Hide teams section content
            const teamsTitle = document.getElementById('teams-title');
            const noTeamsMessage = document.getElementById('no-teams-message');
            const addTeamBtn = document.getElementById('add-team-btn');
            
            if (teamsTitle) teamsTitle.textContent = 'Step 2: Event Teams';
            if (noTeamsMessage) noTeamsMessage.style.display = 'block';
            if (addTeamBtn) addTeamBtn.style.display = 'none';
            
            // Hide existing teams display
            const teamsContainer = document.querySelector('.columns.is-multiline');
            if (teamsContainer) teamsContainer.style.display = 'none';
            
        } else if (eventId > 0) {
            // Load selected event data via AJAX
            fetch(`/api/event/${eventId}`)
                .then(response => {
                    console.log('API Response status:', response.status);
                    console.log('API Response headers:', response.headers);
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('API Error response body:', text);
                            throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API Response data:', data);
                    try {
                        // Update event form
                        eventIdInput.value = data.id;
                        nameInput.value = data.name;
                        typeSelect.value = data.event_type;
                    
                    // Update new fields
                    const genderSelect = document.getElementById('gender');
                    const formatSelect = document.getElementById('format');
                    const scoringInput = document.getElementById('scoring');
                            const eventManagersCheckboxes = document.querySelectorAll('input[name="event_managers"]');
                    
                    if (genderSelect) genderSelect.value = data.gender;
                    if (formatSelect) formatSelect.value = data.format;
                    if (scoringInput) scoringInput.value = data.scoring || '';
                    
                    // Update event managers checkboxes
                    if (eventManagersCheckboxes) {
                        eventManagersCheckboxes.forEach(checkbox => {
                            checkbox.checked = data.event_managers.some(manager => manager.id == checkbox.value);
                        });
                    }
                    
                    const eventFormTitle = document.getElementById('event-form-title');
                    if (eventFormTitle) {
                        eventFormTitle.textContent = `Step 1: Edit Event Details`;
                        // Add completion indicator safely
                        const completionTag = document.createElement('span');
                        completionTag.className = 'tag is-success ml-2';
                        
                        const iconSpan = document.createElement('span');
                        iconSpan.className = 'icon is-small';
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-check';
                        iconSpan.appendChild(icon);
                        
                        const textSpan = document.createElement('span');
                        textSpan.textContent = 'Complete';
                        
                        completionTag.appendChild(iconSpan);
                        completionTag.appendChild(textSpan);
                        eventFormTitle.appendChild(completionTag);
                    }
                    
                    // Update bookings section  
                    const bookingsTitle = document.getElementById('bookings-title');
                    if (bookingsTitle) {
                        bookingsTitle.textContent = `Step 3: Bookings for ${data.name}`;
                    }
                    if (noBookingsMessage) noBookingsMessage.style.display = 'none';
                    if (toggleBookingBtn) {
                        toggleBookingBtn.style.display = 'inline-flex';
                        toggleBookingBtn.disabled = true; // Will be updated when teams are loaded
                        toggleBookingBtn.title = 'Add teams first before creating bookings';
                    }
                    
                    // Update teams section
                    const teamsTitle = document.getElementById('teams-title');
                    const noTeamsMessage = document.getElementById('no-teams-message');
                    const addTeamBtn = document.getElementById('add-team-btn');
                    
                    if (teamsTitle) {
                        teamsTitle.textContent = `Step 2: Teams for ${data.name}`;
                        // Add warning indicator safely
                        const warningTag = document.createElement('span');
                        warningTag.className = 'tag is-warning ml-2';
                        
                        const iconSpan = document.createElement('span');
                        iconSpan.className = 'icon is-small';
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-exclamation';
                        iconSpan.appendChild(icon);
                        
                        const textSpan = document.createElement('span');
                        textSpan.textContent = 'Add teams';
                        
                        warningTag.appendChild(iconSpan);
                        warningTag.appendChild(textSpan);
                        teamsTitle.appendChild(warningTag);
                    }
                    if (noTeamsMessage) noTeamsMessage.style.display = 'none';
                    if (addTeamBtn) addTeamBtn.style.display = 'inline-flex';
                    
                    // Load bookings for this event
                    loadEventBookings(eventId);
                    } catch (formError) {
                        console.error('Error updating form elements:', formError);
                        throw formError;
                    }
                })
                .catch(error => {
                    console.error('Error loading event:', error);
                    console.error('Error details:', error.message);
                    alert('Error loading event data. Please try again. Check console for details.');
                });
        }
    });
    
    // Function to load bookings for an event
    function loadEventBookings(eventId) {
        // For now, we'll reload the page with the event_id parameter
        // This ensures all the bookings are loaded with proper server-side rendering
        window.location.href = `/admin/manage_events?event_id=${eventId}`;
    }

    // Handle booking form toggle
    if (toggleBookingFormBtn && bookingFormSection) {
        toggleBookingFormBtn.addEventListener('click', function() {
            // Prevent action if button is disabled
            if (this.disabled) {
                return;
            }
            
            bookingFormSection.classList.toggle('is-hidden');
            if (!bookingFormSection.classList.contains('is-hidden')) {
                this.textContent = 'Cancel';
                this.classList.remove('is-success');
                this.classList.add('is-warning');
            } else {
                this.innerHTML = '<span class="icon"><i class="fas fa-plus"></i></span><span>Add Booking</span>';
                this.classList.remove('is-warning');
                this.classList.add('is-success');
            }
        });
    }

    // Handle cancel booking button
    if (cancelBookingBtn && bookingFormSection) {
        cancelBookingBtn.addEventListener('click', function() {
            bookingFormSection.classList.add('is-hidden');
            toggleBookingFormBtn.innerHTML = '<span class="icon"><i class="fas fa-plus"></i></span><span>Add Booking</span>';
            toggleBookingFormBtn.classList.remove('is-warning');
            toggleBookingFormBtn.classList.add('is-success');
            
            // Clear the booking form
            document.getElementById('booking-form').reset();
            hideBookingAvailability();
        });
    }

    // Booking availability checking (reuse logic from booking form)
    function updateBookingAvailability() {
        const date = bookingDateInput?.value;
        const session = bookingSessionSelect?.value;
        
        if (date && session) {
            fetch(`/get_availability/${date}/${session}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayBookingAvailability(data);
                })
                .catch(error => {
                    console.error('Error fetching availability:', error);
                    hideBookingAvailability();
                });
        } else {
            hideBookingAvailability();
        }
    }

    function displayBookingAvailability(data) {
        const availableRinks = data.available_rinks;
        const bookedRinks = data.booked_rinks;
        const totalRinks = data.total_rinks;
        
        let message = '';
        let notificationClass = '';
        
        if (availableRinks === totalRinks) {
            message = `All ${totalRinks} rinks are available for this session.`;
            notificationClass = 'is-success';
        } else if (availableRinks > 0) {
            message = `${availableRinks} of ${totalRinks} rinks available (${bookedRinks} already booked).`;
            notificationClass = 'is-warning';
        } else {
            message = `This session is fully booked (${bookedRinks}/${totalRinks} rinks).`;
            notificationClass = 'is-danger';
        }
        
        bookingAvailabilityInfo.innerHTML = `
            <div class="has-text-weight-bold">Availability Status:</div>
            ${message}
        `;
        
        bookingAvailabilityInfo.className = `notification ${notificationClass}`;
        
        // Update the max value for rink count input
        bookingRinkCountInput.setAttribute('max', Math.max(0, availableRinks));
        
        // If current value exceeds available rinks, show warning
        const currentValue = parseInt(bookingRinkCountInput.value) || 0;
        if (currentValue > availableRinks) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'has-text-danger';
            warningDiv.innerHTML = `<br><strong>Warning:</strong> You've requested ${currentValue} rinks, but only ${availableRinks} are available.`;
            bookingAvailabilityInfo.appendChild(warningDiv);
        }
    }

    function hideBookingAvailability() {
        if (bookingAvailabilityInfo) {
            bookingAvailabilityInfo.className = 'notification is-hidden';
            bookingAvailabilityInfo.innerHTML = '';
        }
        if (bookingRinkCountInput) {
            bookingRinkCountInput.removeAttribute('max');
        }
    }

    // Add event listeners for booking availability checking
    if (bookingDateInput) {
        bookingDateInput.addEventListener('change', updateBookingAvailability);
    }
    if (bookingSessionSelect) {
        bookingSessionSelect.addEventListener('change', updateBookingAvailability);
    }
    if (bookingRinkCountInput) {
        bookingRinkCountInput.addEventListener('input', function() {
            if (bookingDateInput?.value && bookingSessionSelect?.value) {
                updateBookingAvailability();
            }
        });
    }

    // Inline booking editing functionality
    document.addEventListener('click', function(e) {
        // Handle edit booking button
        if (e.target.closest('.edit-booking-btn')) {
            const button = e.target.closest('.edit-booking-btn');
            const bookingId = button.dataset.bookingId;
            const displayRow = document.getElementById(`booking-row-${bookingId}`);
            const editRow = document.getElementById(`booking-edit-row-${bookingId}`);
            
            if (displayRow && editRow) {
                displayRow.classList.add('is-hidden');
                editRow.classList.remove('is-hidden');
            }
        }
        
        // Handle cancel edit button
        if (e.target.closest('.cancel-edit-btn')) {
            const button = e.target.closest('.cancel-edit-btn');
            const form = button.closest('.booking-edit-form');
            const bookingId = form.dataset.bookingId;
            const displayRow = document.getElementById(`booking-row-${bookingId}`);
            const editRow = document.getElementById(`booking-edit-row-${bookingId}`);
            
            if (displayRow && editRow) {
                editRow.classList.add('is-hidden');
                displayRow.classList.remove('is-hidden');
            }
        }
        
        // Handle delete booking button
        if (e.target.closest('.delete-booking-btn')) {
            const button = e.target.closest('.delete-booking-btn');
            const bookingId = button.dataset.bookingId;
            
            if (confirm('Are you sure you want to delete this booking?')) {
                // Create a form for deletion
                const form = document.createElement('form');
                form.method = 'POST';
                form.style.display = 'none';
                
                // Add CSRF token
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                // Add booking ID
                const bookingIdInput = document.createElement('input');
                bookingIdInput.type = 'hidden';
                bookingIdInput.name = 'booking_id';
                bookingIdInput.value = bookingId;
                form.appendChild(bookingIdInput);
                
                // Add event ID
                const eventId = document.getElementById('event_id').value;
                const eventIdInput = document.createElement('input');
                eventIdInput.type = 'hidden';
                eventIdInput.name = 'event_id';
                eventIdInput.value = eventId;
                form.appendChild(eventIdInput);
                
                // Add delete action
                const deleteInput = document.createElement('input');
                deleteInput.type = 'hidden';
                deleteInput.name = 'delete_booking';
                deleteInput.value = 'true';
                form.appendChild(deleteInput);
                
                // Submit form
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Handle add team button
        if (e.target.closest('#add-team-btn')) {
            const eventId = document.getElementById('event_id').value;
            if (eventId) {
                window.location.href = `/admin/add_event_team/${eventId}`;
            }
        }
        
        // Handle delete team button
        if (e.target.closest('.delete-team-btn')) {
            const button = e.target.closest('.delete-team-btn');
            const teamId = button.dataset.teamId;
            const teamName = button.dataset.teamName;
            
            if (confirm(`Are you sure you want to delete team "${teamName}"? This will also remove all player assignments and cannot be undone.`)) {
                // Create a form for deletion
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/admin/delete_event_team/${teamId}`;
                form.style.display = 'none';
                
                // Add CSRF token
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                // Submit form
                document.body.appendChild(form);
                form.submit();
            }
        }
    });

    // Prevent double submission of booking form
    const bookingForm = document.querySelector('form[method="POST"]');
    const createBookingBtn = document.getElementById('create-booking-btn');
    const bookingLoadingIcon = document.getElementById('booking-loading-icon');
    const bookingBtnText = document.getElementById('booking-btn-text');
    
    if (bookingForm && createBookingBtn) {
        bookingForm.addEventListener('submit', function(e) {
            // Check if form is already being submitted
            if (createBookingBtn.disabled) {
                e.preventDefault();
                return false;
            }
            
            // Only prevent double submission for booking creation
            const submitButton = e.submitter;
            if (submitButton && submitButton.name === 'create_booking') {
                // Disable button and show loading state
                createBookingBtn.disabled = true;
                createBookingBtn.classList.add('is-loading');
                bookingLoadingIcon.classList.remove('is-hidden');
                bookingBtnText.textContent = 'Creating...';
                
                // Re-enable after a timeout as fallback (in case of error)
                setTimeout(function() {
                    createBookingBtn.disabled = false;
                    createBookingBtn.classList.remove('is-loading');
                    bookingLoadingIcon.classList.add('is-hidden');
                    bookingBtnText.textContent = 'Create Booking';
                }, 10000); // 10 second timeout
            }
        });
    }

    // Pool Management Modal Functions
    function showAutoSelectModal() {
        const eventId = document.getElementById('page-data').dataset.selectedEventId;
        if (!eventId) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal is-active';
        modal.innerHTML = `
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Auto-Select Pool Members</p>
                    <button class="delete" aria-label="close" onclick="closeModal(this)"></button>
                </header>
                <section class="modal-card-body">
                    <form method="POST" action="/admin/auto_select_pool_members/${eventId}">
                        <input type="hidden" name="csrf_token" value="${getCSRFToken()}">
                        <div class="field">
                            <label class="label">Selection Method</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select name="method">
                                        <option value="oldest_first">Oldest Registration First</option>
                                        <option value="random">Random Selection</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Number of Members to Select</label>
                            <div class="control">
                                <input type="number" name="count" class="input" min="1" max="20" required>
                            </div>
                            <p class="help">Select how many members to mark as available for team creation</p>
                        </div>
                    </form>
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-success" onclick="submitAutoSelect()">Auto-Select</button>
                    <button class="button" onclick="closeModal(this)">Cancel</button>
                </footer>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function showBulkStatusModal() {
        const eventId = document.getElementById('page-data').dataset.selectedEventId;
        if (!eventId) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal is-active';
        modal.innerHTML = `
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Bulk Status Update</p>
                    <button class="delete" aria-label="close" onclick="closeModal(this)"></button>
                </header>
                <section class="modal-card-body">
                    <form method="POST" action="/admin/bulk_update_pool_status/${eventId}">
                        <input type="hidden" name="csrf_token" value="${getCSRFToken()}">
                        <div class="field">
                            <label class="label">Action</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select name="action">
                                        <option value="mark_all_available">Mark All Registered as Available</option>
                                        <option value="clear_selections">Clear All Selections (Return to Available)</option>
                                    </select>
                                </div>
                            </div>
                            <p class="help">Choose the bulk action to apply to pool members</p>
                        </div>
                    </form>
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-warning" onclick="submitBulkStatus()">Apply Changes</button>
                    <button class="button" onclick="closeModal(this)">Cancel</button>
                </footer>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function showCreateTeamsModal() {
        const eventId = document.getElementById('page-data').dataset.selectedEventId;
        if (!eventId) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal is-active';
        modal.innerHTML = `
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Create Teams from Pool</p>
                    <button class="delete" aria-label="close" onclick="closeModal(this)"></button>
                </header>
                <section class="modal-card-body">
                    <form method="POST" action="/admin/create_teams_from_pool/${eventId}">
                        <input type="hidden" name="csrf_token" value="${getCSRFToken()}">
                        <div class="notification is-info">
                            <p><strong>This will create teams using available pool members.</strong></p>
                            <p>Members will be automatically assigned to positions and their status will be updated to "selected".</p>
                        </div>
                    </form>
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-primary" onclick="submitCreateTeams()">Create Teams</button>
                    <button class="button" onclick="closeModal(this)">Cancel</button>
                </footer>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function showCreateBookingModal() {
        const eventId = document.getElementById('page-data').dataset.selectedEventId;
        const eventName = document.getElementById('page-data').dataset.selectedEventName;
        if (!eventId) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal is-active';
        modal.innerHTML = `
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Create Booking from Teams</p>
                    <button class="delete" aria-label="close" onclick="closeModal(this)"></button>
                </header>
                <section class="modal-card-body">
                    <form method="POST" action="/admin/copy_teams_to_booking/${eventId}">
                        <input type="hidden" name="csrf_token" value="${getCSRFToken()}">
                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="label">Booking Date</label>
                                    <div class="control">
                                        <input type="date" name="booking_date" class="input" required>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">Session</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            <select name="session" required>
                                                <option value="1">Morning (AM)</option>
                                                <option value="2">Afternoon (PM)</option>
                                                <option value="3">Evening</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="columns">
                            <div class="column">
                                <div class="field">
                                    <label class="label">Opposition Team</label>
                                    <div class="control">
                                        <input type="text" name="vs" class="input" placeholder="e.g., Riverdale Bowls Club">
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="field">
                                    <label class="label">Home/Away</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            <select name="home_away">
                                                <option value="home">Home</option>
                                                <option value="away">Away</option>
                                                <option value="neutral">Neutral</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Priority</label>
                            <div class="control">
                                <input type="text" name="priority" class="input" placeholder="e.g., League Match">
                            </div>
                        </div>
                    </form>
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-success" onclick="submitCreateBooking()">Create Booking</button>
                    <button class="button" onclick="closeModal(this)">Cancel</button>
                </footer>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function closeModal(element) {
        const modal = element.closest('.modal');
        if (modal) {
            modal.remove();
        }
    }

    function submitAutoSelect() {
        const modal = document.querySelector('.modal.is-active');
        const form = modal.querySelector('form');
        form.submit();
    }

    function submitBulkStatus() {
        const modal = document.querySelector('.modal.is-active');
        const form = modal.querySelector('form');
        form.submit();
    }

    function submitCreateTeams() {
        const modal = document.querySelector('.modal.is-active');
        const form = modal.querySelector('form');
        form.submit();
    }

    function submitCreateBooking() {
        const modal = document.querySelector('.modal.is-active');
        const form = modal.querySelector('form');
        form.submit();
    }

    function getCSRFToken() {
        const token = document.querySelector('input[name="csrf_token"]');
        return token ? token.value : '';
    }

    // Close modal when clicking background
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-background')) {
            closeModal(e.target);
        }
    });
});
</script>

{% endblock %}